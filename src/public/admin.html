<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ÁÆ°ÁêÜÂëòÊéßÂà∂Âè∞ - ClaudeAPI v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-slideOut {
            animation: slideOut 0.3s ease-out forwards;
        }

        .animate-scaleIn {
            animation: scaleIn 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Âä†ËΩΩ‰∏≠ -->
    <div id="loadingPage" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
            </div>
            <p class="text-gray-500">Âä†ËΩΩ‰∏≠...</p>
        </div>
    </div>

    <!-- ‰∏ªÈù¢Êùø -->
    <div id="mainPanel" class="hidden">
        <!-- È°∂ÈÉ®ÂØºËà™ -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <div>
                            <span class="text-xl font-bold text-gray-900">ClaudeAPI</span>
                            <span class="ml-2 text-sm text-gray-500">ÁÆ°ÁêÜÂëòÊéßÂà∂Âè∞</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="logout()"
                            class="text-gray-500 hover:text-gray-700 text-sm font-medium transition">ÈÄÄÂá∫ÁôªÂΩï</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fadeIn">
            <!-- Á¨¨‰∏ÄË°åÁªüËÆ°Âç°Áâá -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="text-2xl font-bold text-gray-900" id="stat-active">-</div>
                    <div class="text-sm text-gray-500">Ê¥ªË∑ÉË¥¶Âè∑</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="text-2xl font-bold text-yellow-500" id="stat-cooldown">-</div>
                    <div class="text-sm text-gray-500">ÂÜ∑Âç¥‰∏≠</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="text-2xl font-bold text-red-500" id="stat-invalid">-</div>
                    <div class="text-sm text-gray-500">Â∑≤Â§±Êïà</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="text-2xl font-bold text-gray-900" id="stat-requests">-</div>
                    <div class="text-sm text-gray-500">ÊÄªËØ∑Ê±Ç</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="text-2xl font-bold text-blue-500" id="stat-input">-</div>
                    <div class="text-sm text-gray-500">ËæìÂÖ•Tokens</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="text-2xl font-bold text-green-500" id="stat-output">-</div>
                    <div class="text-sm text-gray-500">ËæìÂá∫Tokens</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="text-2xl font-bold text-purple-500" id="stat-uptime">-</div>
                    <div class="text-sm text-gray-500">ËøêË°åÊó∂Èó¥</div>
                </div>
            </div>

            <!-- Á¨¨‰∫åË°åÔºöÈ¢ùÂ∫¶ÁªüËÆ°ÂíåÂõæË°® -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- ÊÄªÈ¢ùÂ∫¶Âç°Áâá -->
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 shadow-lg text-white">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-sm font-medium opacity-90">Ë¥¶Âè∑Ê±†ÊÄªÈ¢ùÂ∫¶</div>
                        <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                    </div>
                    <div class="text-3xl font-bold mb-2" id="stat-total-quota">-</div>
                    <div class="flex items-center justify-between text-sm opacity-90">
                        <span>ÂèØÁî®: <span id="stat-available-quota" class="font-semibold">-</span></span>
                        <span>Â∑≤Áî®: <span id="stat-used-percent" class="font-semibold">-</span></span>
                    </div>
                    <div class="mt-3 h-2 bg-white bg-opacity-20 rounded-full overflow-hidden">
                        <div id="quota-progress" class="h-full bg-white rounded-full transition-all" style="width: 0%">
                        </div>
                    </div>
                </div>

                <!-- ‰ªäÊó•ÁªüËÆ° -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h4 class="text-sm font-semibold text-gray-700 mb-4">‰ªäÊó•ÁªüËÆ°</h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">ËØ∑Ê±ÇÊï∞</span>
                            <span class="text-lg font-bold text-gray-900" id="today-requests">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Ê∂àËÄó</span>
                            <span class="text-lg font-bold text-green-600" id="today-revenue">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">ËæìÂÖ•Tokens</span>
                            <span class="text-sm font-medium text-blue-600" id="today-input">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">ËæìÂá∫Tokens</span>
                            <span class="text-sm font-medium text-green-600" id="today-output">-</span>
                        </div>
                    </div>
                </div>

                <!-- ÊúÄËøë7Â§©Ë∂ãÂäø -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                    <h4 class="text-sm font-semibold text-gray-700 mb-4">ÊúÄËøë7Â§©ËØ∑Ê±ÇË∂ãÂäø</h4>
                    <div style="position: relative; height: 150px; width: 100%;">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Ê†áÁ≠æÈ°µ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
                <div class="border-b border-gray-100">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="switchTab('users')"
                            class="tab-btn border-b-2 border-blue-500 text-blue-600 py-4 px-1 text-sm font-medium"
                            data-tab="users">Áî®Êà∑ÁÆ°ÁêÜ</button>
                        <button onclick="switchTab('accounts')"
                            class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium"
                            data-tab="accounts">KiroË¥¶Âè∑Ê±†</button>
                        <button onclick="switchTab('agt-accounts')"
                            class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium"
                            data-tab="agt-accounts">AGTË¥¶Âè∑Ê±†</button>
                        <button onclick="switchTab('logs')"
                            class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium"
                            data-tab="logs">ËØ∑Ê±ÇËÆ∞ÂΩï</button>
                        <button onclick="switchTab('settings')"
                            class="tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium"
                            data-tab="settings">Á≥ªÁªüËÆæÁΩÆ</button>
                    </nav>
                </div>

                <!-- Áî®Êà∑ÁÆ°ÁêÜ -->
                <div id="tab-users" class="p-6 tab-content">
                    <div class="flex justify-end items-center mb-6">
                        <button onclick="showModal('createUserModal')"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            ÂàõÂª∫Áî®Êà∑
                        </button>
                    </div>
                    <div id="users-table" class="overflow-x-auto"></div>

                    <!-- Áî®Êà∑ÂàÜÈ°µÊéß‰ª∂ -->
                    <div id="users-pagination"
                        class="flex items-center justify-between mt-6 pt-4 border-t border-gray-100 hidden">
                        <div class="text-sm text-gray-600">
                            ÊòæÁ§∫ <span id="users-page-start">0</span> - <span id="users-page-end">0</span>ÔºåÂÖ± <span
                                id="total-users">0</span> ‰∏™Áî®Êà∑
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="changeUsersPage('prev')" id="users-prev-btn"
                                class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>‰∏ä‰∏ÄÈ°µ</button>
                            <div id="users-page-numbers" class="flex gap-1"></div>
                            <button onclick="changeUsersPage('next')" id="users-next-btn"
                                class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    </div>
                </div>

                <!-- KiroË¥¶Âè∑ÁÆ°ÁêÜ -->
                <div id="tab-accounts" class="p-6 tab-content hidden">
                    <div class="flex flex-wrap items-center gap-3 mb-6">
                        <button onclick="showModal('addModal')"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Ê∑ªÂä†Ë¥¶Âè∑
                        </button>
                        <button onclick="showModal('importModal')"
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            ÊâπÈáèÂØºÂÖ•
                        </button>
                        <button onclick="refreshAllUsage()"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Âà∑Êñ∞ÂÖ®ÈÉ®È¢ùÂ∫¶
                        </button>
                        <button id="batchDeleteBtn" onclick="batchDeleteAccounts()"
                            class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            ÊâπÈáèÂà†Èô§ (<span id="selectedCount">0</span>)
                        </button>
                        <select id="strategy" onchange="setStrategy(this.value)"
                            class="border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="round-robin">ËΩÆËØ¢Á≠ñÁï•</option>
                            <option value="random">ÈöèÊú∫Á≠ñÁï•</option>
                            <option value="least-used">ÊúÄÂ∞ë‰ΩøÁî®</option>
                        </select>
                        <button onclick="refresh()"
                            class="border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 transition">Âà∑Êñ∞</button>
                    </div>
                    <div id="accounts-table"></div>

                    <!-- ÂàÜÈ°µÊéß‰ª∂ -->
                    <div id="accounts-pagination"
                        class="flex items-center justify-between mt-6 pt-4 border-t border-gray-100">
                        <div class="text-sm text-gray-600">
                            ÊòæÁ§∫ <span id="page-start">0</span> - <span id="page-end">0</span>ÔºåÂÖ± <span
                                id="total-accounts">0</span> ‰∏™Ë¥¶Âè∑
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="changePage('prev')" id="prev-btn"
                                class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>‰∏ä‰∏ÄÈ°µ</button>
                            <div id="page-numbers" class="flex gap-1"></div>
                            <button onclick="changePage('next')" id="next-btn"
                                class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    </div>
                </div>

                <div id="tab-agt-accounts" class="p-6 tab-content hidden">
                    <!-- ÂèØÁî®Ê®°Âûã‰ø°ÊÅØ -->
                    <div
                        class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-indigo-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div class="flex-1">
                                <div class="font-semibold text-indigo-900 mb-2">AGT ÂèØÁî®Ê®°Âûã ID</div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <code
                                            class="bg-white px-2 py-1 rounded border border-indigo-200 text-indigo-700 font-mono text-xs">gemini-3-pro-high</code>
                                        <span class="text-gray-600 text-xs">Gemini 3 Pro</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <code
                                            class="bg-white px-2 py-1 rounded border border-indigo-200 text-indigo-700 font-mono text-xs">gemini-3-flash</code>
                                        <span class="text-gray-600 text-xs">Gemini 3 Flash</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <code
                                            class="bg-white px-2 py-1 rounded border border-indigo-200 text-indigo-700 font-mono text-xs">claude-sonnet-4-5</code>
                                        <span class="text-gray-600 text-xs">Claude Sonnet 4.5</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <code
                                            class="bg-white px-2 py-1 rounded border border-indigo-200 text-indigo-700 font-mono text-xs">claude-sonnet-4-5-thinking</code>
                                        <span class="text-gray-600 text-xs">Sonnet 4.5 Thinking</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <code
                                            class="bg-white px-2 py-1 rounded border border-indigo-200 text-indigo-700 font-mono text-xs">claude-opus-4-5-thinking</code>
                                        <span class="text-gray-600 text-xs">Opus 4.5 Thinking</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <code
                                            class="bg-white px-2 py-1 rounded border border-indigo-200 text-indigo-700 font-mono text-xs">claude-opus-4-6-thinking</code>
                                        <span class="text-gray-600 text-xs">Opus 4.6 Thinking</span>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-indigo-700">
                                    üí° ÊèêÁ§∫Ôºö‰ΩøÁî®Ëøô‰∫õÊ®°Âûã ID Êó∂ÔºåÈúÄË¶ÅÂú®ÂâçÈù¢Âä†‰∏ä <code
                                        class="bg-white px-1 rounded border border-indigo-200">antigravity-</code>
                                    ÂâçÁºÄÔºå‰æãÂ¶ÇÔºö<code
                                        class="bg-white px-1 rounded border border-indigo-200">antigravity-gemini-3-pro-high</code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center gap-3 mb-6">
                        <button onclick="showModal('agtImportModal')"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            ÂØºÂÖ• AGT Ë¥¶Âè∑
                        </button>
                        <button onclick="refreshAllAgtUsage()"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Âà∑Êñ∞ÂÖ®ÈÉ®È¢ùÂ∫¶
                        </button>

                        <button onclick="loadAgtAccounts()"
                            class="border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 transition">Âà∑Êñ∞ÂàóË°®</button>
                    </div>
                    <div id="agt-accounts-table"></div>
                </div>

                <!-- ËØ∑Ê±ÇËÆ∞ÂΩï -->
                <div id="tab-logs" class="p-6 tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex gap-3">
                            <button onclick="loadLogs()"
                                class="border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 transition">Âà∑Êñ∞</button>
                            <button onclick="clearLogs()"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Ê∏ÖÁ©∫ËÆ∞ÂΩï
                            </button>
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()"
                                class="sr-only peer">
                            <div
                                class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                            </div>
                            <span class="ml-3 text-sm font-medium text-gray-700">Ëá™Âä®Âà∑Êñ∞</span>
                        </label>
                    </div>
                    <div id="logs-table" class="overflow-x-auto"></div>

                    <!-- Êó•ÂøóÂàÜÈ°µÊéß‰ª∂ -->
                    <div id="logs-pagination"
                        class="flex items-center justify-between mt-6 pt-4 border-t border-gray-100 hidden">
                        <div class="text-sm text-gray-600">
                            ÊòæÁ§∫ <span id="logs-page-start">0</span> - <span id="logs-page-end">0</span>ÔºåÂÖ± <span
                                id="total-logs">0</span> Êù°ËÆ∞ÂΩï
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="changeLogsPage('prev')" id="logs-prev-btn"
                                class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>‰∏ä‰∏ÄÈ°µ</button>
                            <div id="logs-page-numbers" class="flex gap-1"></div>
                            <button onclick="changeLogsPage('next')" id="logs-next-btn"
                                class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    </div>
                </div>

                <!-- ËÆæÁΩÆ -->
                <div id="tab-settings" class="p-6 tab-content hidden">
                    <div class="max-w-2xl">
                        <!-- API Á´ØÁÇπ‰ø°ÊÅØ -->
                        <div class="mb-8 p-4 bg-gray-50 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">API Á´ØÁÇπ</h3>

                            <div class="mb-4">
                                <p class="text-xs text-gray-500 mb-2 font-medium">Anthropic Ê†ºÂºè</p>
                                <div class="space-y-2 font-mono text-sm">
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">GET</span>
                                        <span class="text-gray-700">/v1/models</span>
                                        <button onclick="copyText(location.origin + '/v1/models')"
                                            class="text-blue-500 hover:text-blue-700 text-xs">Â§çÂà∂</button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">POST</span>
                                        <span class="text-gray-700">/v1/messages</span>
                                        <button onclick="copyText(location.origin + '/v1/messages')"
                                            class="text-blue-500 hover:text-blue-700 text-xs">Â§çÂà∂</button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">POST</span>
                                        <span class="text-gray-700">/v1/chat/completions</span>
                                        <button onclick="copyText(location.origin + '/v1/chat/completions')"
                                            class="text-blue-500 hover:text-blue-700 text-xs">Â§çÂà∂</button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-medium">POST</span>
                                        <span class="text-gray-700">/v1internal:generateContent</span>
                                        <button onclick="copyText(location.origin + '/v1internal:generateContent')"
                                            class="text-blue-500 hover:text-blue-700 text-xs">Â§çÂà∂</button>
                                    </div>
                                </div>
                            </div>

                            <p class="text-xs text-gray-500 mt-3">Base URL: <span class="text-gray-700"
                                    id="baseUrl"></span></p>
                        </div>

                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">ÁÆ°ÁêÜÂØÜÈí•</h3>
                            <p class="text-sm text-gray-500 mb-4">Áî®‰∫éÁôªÂΩïÁÆ°ÁêÜÈù¢Êùø</p>
                            <div class="flex gap-3">
                                <input type="password" id="new-admin-key" placeholder="ËæìÂÖ•Êñ∞ÁöÑÁÆ°ÁêÜÂØÜÈí•"
                                    class="flex-1 max-w-xs px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="changeAdminKey()"
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">‰øÆÊîπÂØÜÈí•</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄöÁü•ÂÆπÂô® -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Ê∑ªÂä†Ë¥¶Âè∑ÂºπÁ™ó -->
    <div id="addModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 animate-scaleIn">
            <div class="flex items-center justify-between p-6 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">Ê∑ªÂä†Ë¥¶Âè∑</h3>
                <button onclick="hideModal('addModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <input type="text" id="acc-name" placeholder="Ë¥¶Âè∑ÂêçÁß∞"
                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="acc-auth" onchange="toggleIdcFields()"
                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="social">Social</option>
                    <option value="idc">IdC / BuilderId</option>
                </select>
                <textarea id="acc-refresh" placeholder="Refresh Token" rows="3"
                    class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                <div id="idc-fields" class="hidden space-y-4">
                    <input type="text" id="acc-client-id" placeholder="Client ID"
                        class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <textarea id="acc-client-secret" placeholder="Client Secret" rows="2"
                        class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-100">
                <button onclick="hideModal('addModal')"
                    class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition">ÂèñÊ∂à</button>
                <button onclick="addAccount()"
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition">Ê∑ªÂä†</button>
            </div>
        </div>
    </div>

    <div id="agtImportModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl mx-4 animate-scaleIn">
            <div class="flex items-center justify-between p-6 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">ÂØºÂÖ• AGT Ë¥¶Âè∑</h3>
                <button onclick="hideModal('agtImportModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <p class="text-sm text-gray-600">ÊîØÊåÅÂçïÂØπË±°„ÄÅÊï∞ÁªÑÊàñ { accounts: [] } Ê†ºÂºè</p>
                    <button onclick="loadAgtTemplate()" class="text-sm text-blue-600 hover:text-blue-700">Âä†ËΩΩÊ®°Êùø</button>
                </div>
                <textarea id="agt-import-json" rows="12"
                    class="w-full px-3 py-2 border border-gray-200 rounded-lg font-mono text-xs resize-y focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    placeholder="Á≤òË¥¥ ~/.cli-proxy-api/antigravity-*.json ÂÜÖÂÆπ"></textarea>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-100">
                <button onclick="hideModal('agtImportModal')"
                    class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition">ÂèñÊ∂à</button>
                <button onclick="importAgtAccounts()"
                    class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg text-sm font-medium transition">ÂºÄÂßãÂØºÂÖ•</button>
            </div>
        </div>
    </div>

    <!-- ÂàõÂª∫Áî®Êà∑ÂºπÁ™ó -->
    <div id="createUserModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div
            class="bg-white rounded-3xl shadow-2xl w-full max-w-lg animate-scaleIn overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="relative bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 p-6 text-white">
                <button onclick="hideModal('createUserModal')"
                    class="absolute top-4 right-4 text-white/80 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">ÂàõÂª∫Áî®Êà∑</h3>
                        <p class="text-sm text-white/80">Âø´ÈÄüÂàõÂª∫Áî®Êà∑Âπ∂ÂºÄÈÄöËÆ¢ÈòÖ</p>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-5">
                <!-- Áî®Êà∑ÂêçÈ¢ÑËßà -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-sm font-medium text-gray-700">Áî®Êà∑ÂêçÈ¢ÑËßà</span>
                    </div>
                    <div class="font-mono text-sm text-gray-600" id="username-preview">user_abc123</div>
                </div>

                <!-- Áî®Êà∑Âêç -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ëá™ÂÆö‰πâÁî®Êà∑ÂêçÔºàÂèØÈÄâÔºâ</label>
                    <input type="text" id="new-username" placeholder="ÁïôÁ©∫Ëá™Âä®ÁîüÊàê" oninput="updateUsernamePreview()"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>

                <!-- ÂàõÂª∫Êï∞Èáè -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂàõÂª∫Êï∞Èáè</label>
                    <input type="number" id="new-count" value="1" min="1" max="100" oninput="updateUsernamePreview()"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    <p class="text-xs text-gray-500 mt-1">ÊâπÈáèÂàõÂª∫Êó∂Ëá™Âä®ÁîüÊàêÂîØ‰∏ÄÁî®Êà∑Âêç</p>
                </div>

                <!-- ÂàùÂßã‰ΩôÈ¢ù -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÂàùÂßã‰ΩôÈ¢ù (USD)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-semibold">$</span>
                        <input type="number" step="0.01" id="new-balance" value="0"
                            class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">üí° ÂºÄÈÄöËÆ¢ÈòÖÂêé‰ºöÁ´ãÂç≥Ëé∑ÂæóÈ¶ñÊ¨°ÂÖÖÂÄºÈ¢ùÂ∫¶</p>
                </div>

                <!-- ËÆ¢ÈòÖÈÄâÈ°π -->
                <div class="border-2 border-gray-200 rounded-xl p-4">
                    <label class="flex items-center gap-3 cursor-pointer mb-4">
                        <input type="checkbox" id="new-with-subscription" onchange="toggleSubscriptionOptions()"
                            class="w-5 h-5 text-blue-500 rounded">
                        <div class="flex-1">
                            <span class="text-sm font-semibold text-gray-900">ÂêåÊó∂ÂºÄÈÄöËÆ¢ÈòÖ</span>
                            <p class="text-xs text-gray-500">ÂàõÂª∫Áî®Êà∑ÂêéÁ´ãÂç≥ÂºÄÈÄöËÆ¢ÈòÖÂ•óÈ§ê</p>
                        </div>
                    </label>

                    <div id="subscription-options" class="hidden space-y-4">
                        <!-- ËÆ¢ÈòÖÁ±ªÂûã -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ËÆ¢ÈòÖÁ±ªÂûã</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="sub-type" value="monthly" checked class="sr-only peer">
                                    <div
                                        class="p-4 border-2 border-gray-200 rounded-xl peer-checked:border-purple-500 peer-checked:bg-purple-50 transition-all hover:border-purple-300">
                                        <div class="flex items-center gap-2 mb-1">
                                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <span class="font-medium text-gray-900">ÊØèÊúàÈáçÁΩÆ</span>
                                        </div>
                                        <div class="text-xs text-gray-500">ÊØèÊúàËá™Âä®ÂÖÖÂÄº</div>
                                    </div>
                                </label>
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="sub-type" value="daily" class="sr-only peer">
                                    <div
                                        class="p-4 border-2 border-gray-200 rounded-xl peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all hover:border-blue-300">
                                        <div class="flex items-center gap-2 mb-1">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span class="font-medium text-gray-900">ÊØèÊó•ÈáçÁΩÆ</span>
                                        </div>
                                        <div class="text-xs text-gray-500">ÊØèÂ§©Ëá™Âä®ÂÖÖÂÄº</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- ÂÖÖÂÄºÈ¢ùÂ∫¶ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÂÖÖÂÄºÈ¢ùÂ∫¶ (USD)</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <button type="button" onclick="setSubQuota(1800)"
                                    class="sub-quota-btn px-4 py-2 border-2 border-purple-500 bg-purple-50 text-purple-600 rounded-lg text-sm font-medium transition hover:bg-purple-100">
                                    $1800
                                </button>
                                <button type="button" onclick="setSubQuota(3600)"
                                    class="sub-quota-btn px-4 py-2 border-2 border-gray-200 rounded-lg text-sm font-medium transition hover:border-purple-500 hover:bg-purple-50">
                                    $3600
                                </button>
                            </div>
                            <div class="relative">
                                <span
                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-semibold">$</span>
                                <input type="number" step="0.01" id="new-subscription-quota" value="1800"
                                    placeholder="ÊàñËæìÂÖ•Ëá™ÂÆö‰πâÈ¢ùÂ∫¶"
                                    class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                            </div>
                        </div>

                        <!-- ÂºÄÈÄöÊó∂Èïø -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÂºÄÈÄöÊó∂Èïø</label>
                            <div class="grid grid-cols-4 gap-2 mb-2">
                                <button type="button" onclick="setSubDuration(1)"
                                    class="sub-duration-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 text-sm font-medium transition">
                                    1‰∏™Êúà
                                </button>
                                <button type="button" onclick="setSubDuration(3)"
                                    class="sub-duration-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 text-sm font-medium transition">
                                    3‰∏™Êúà
                                </button>
                                <button type="button" onclick="setSubDuration(6)"
                                    class="sub-duration-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 text-sm font-medium transition">
                                    6‰∏™Êúà
                                </button>
                                <button type="button" onclick="setSubDuration(12)"
                                    class="sub-duration-btn px-3 py-2 border-2 border-purple-500 bg-purple-50 text-purple-600 rounded-lg text-sm font-medium transition">
                                    12‰∏™Êúà
                                </button>
                            </div>
                            <input type="number" id="new-subscription-duration" value="12" min="1" max="120"
                                placeholder="ÊàñËæìÂÖ•Ëá™ÂÆö‰πâÊúàÊï∞"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-start gap-2">
                                <svg class="w-4 h-4 text-green-600 mt-0.5" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div class="text-xs text-green-700">
                                    <div class="font-medium mb-1">ËÆ¢ÈòÖËØ¥Êòé</div>
                                    <div>‚Ä¢ ÂàõÂª∫ÂêéÁ´ãÂç≥ÂÖÖÂÄºÈ¶ñÊ¨°È¢ùÂ∫¶</div>
                                    <div>‚Ä¢ ÊåâÂë®ÊúüËá™Âä®ÂÖÖÂÄºÂà∞Ë¥¶Êà∑</div>
                                    <div>‚Ä¢ Âà∞ÊúüÂêéËá™Âä®ÂÅúÊ≠¢ÂÖÖÂÄº</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="border-t border-gray-200 bg-gray-50 p-6">
                <div class="flex gap-3">
                    <button onclick="hideModal('createUserModal')"
                        class="flex-1 px-4 py-3 bg-white border-2 border-gray-200 rounded-xl font-medium text-gray-600 hover:bg-gray-100 transition-all">
                        ÂèñÊ∂à
                    </button>
                    <button onclick="createUser()"
                        class="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 hover:from-blue-700 hover:via-indigo-700 hover:to-purple-700 text-white rounded-xl font-semibold transition-all shadow-lg shadow-blue-500/30">
                        ÂàõÂª∫Áî®Êà∑
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- È¢ùÂ∫¶Ë∞ÉÊï¥ÂºπÁ™ó -->
    <div id="rechargeModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 animate-scaleIn">
            <div class="flex items-center justify-between p-6 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">‰øÆÊîπÁî®Êà∑È¢ùÂ∫¶</h3>
                <button onclick="hideModal('rechargeModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm text-gray-500">Áî®Êà∑</div>
                    <div class="text-lg font-medium text-gray-900" id="recharge-username">-</div>
                    <div class="text-sm text-gray-500 mt-2">ÂΩìÂâç‰ΩôÈ¢ù</div>
                    <div class="text-2xl font-bold text-green-600" id="recharge-balance">$0.00</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ë∞ÉÊï¥ÈáëÈ¢ù (USD) *</label>
                    <input type="number" step="0.01" id="recharge-amount" placeholder="ËæìÂÖ•Ê≠£Êï∞Â¢ûÂä†ÔºåË¥üÊï∞ÂáèÂ∞ë"
                        class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Á§∫‰æãÔºö+100 Â¢ûÂä†È¢ùÂ∫¶Ôºå-50 Êâ£ÂáèÈ¢ùÂ∫¶</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Â§áÊ≥®ÔºàÂèØÈÄâÔºâ</label>
                    <textarea id="recharge-notes" placeholder="È¢ùÂ∫¶Ë∞ÉÊï¥Â§áÊ≥®" rows="2"
                        class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-100">
                <button onclick="hideModal('rechargeModal')"
                    class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition">ÂèñÊ∂à</button>
                <button onclick="doRecharge()"
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition">Á°ÆËÆ§Ë∞ÉÊï¥</button>
            </div>
        </div>
    </div>

    <!-- ËÆ¢ÈòÖÁÆ°ÁêÜÂºπÁ™ó - ÂÖ®Êñ∞ËÆæËÆ° -->
    <div id="subscriptionModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div
            class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl animate-scaleIn max-h-[95vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="relative bg-gradient-to-br from-purple-600 via-indigo-600 to-blue-600 p-8 text-white">
                <button onclick="hideModal('subscriptionModal')"
                    class="absolute top-6 right-6 text-white/80 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-sm text-white/80 mb-1">‰∏∫Áî®Êà∑ËÆæÁΩÆËÆ¢ÈòÖÂ•óÈ§ê</div>
                        <div class="text-2xl font-bold" id="sub-username">-</div>
                    </div>
                </div>
                <div class="flex gap-2 text-sm text-white/90">
                    <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full">Ëá™Âä®ÂÖÖÂÄº</span>
                    <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full">ÁÅµÊ¥ªÈÖçÁΩÆ</span>
                    <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full">ÂÆûÊó∂ÁîüÊïà</span>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-8 space-y-8">
                <!-- Âø´ÈÄüÂ•óÈ§êÈÄâÊã© -->
                <div>
                    <div class="flex items-center gap-2 mb-4">
                        <div
                            class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">1</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">ÈÄâÊã©Â•óÈ§êÊ®°Êùø</h3>
                        <span class="text-sm text-gray-500">ÔºàÂèØÈÄâÔºâ</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- ÊØèÊó•Âü∫Á°ÄÁâà -->
                        <button onclick="applyTemplate('daily', 5, 1)"
                            class="group relative p-6 border-2 border-gray-200 rounded-2xl hover:border-blue-500 hover:shadow-lg transition-all text-left overflow-hidden">
                            <div
                                class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-transparent rounded-bl-full transform translate-x-8 -translate-y-8">
                            </div>
                            <div class="relative">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-gray-900 text-lg">ÊØèÊó•Âü∫Á°ÄÁâà</div>
                                            <div class="text-xs text-gray-500">ÈÄÇÂêàËΩªÂ∫¶‰ΩøÁî®</div>
                                        </div>
                                    </div>
                                    <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex items-baseline gap-2 mb-2">
                                    <span class="text-3xl font-bold text-gray-900">$5</span>
                                    <span class="text-gray-500">/Â§©</span>
                                </div>
                                <div class="text-sm text-gray-600">ËÆ¢ÈòÖÊó∂ÈïøÔºö1‰∏™Êúà</div>
                            </div>
                        </button>

                        <!-- ÊØèÊó•‰∏ì‰∏öÁâà -->
                        <button onclick="applyTemplate('daily', 10, 1)"
                            class="group relative p-6 border-2 border-gray-200 rounded-2xl hover:border-blue-500 hover:shadow-lg transition-all text-left overflow-hidden">
                            <div
                                class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-transparent rounded-bl-full transform translate-x-8 -translate-y-8">
                            </div>
                            <div class="relative">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-gray-900 text-lg">ÊØèÊó•‰∏ì‰∏öÁâà</div>
                                            <div class="text-xs text-gray-500">ÈÄÇÂêà‰∏≠Â∫¶‰ΩøÁî®</div>
                                        </div>
                                    </div>
                                    <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex items-baseline gap-2 mb-2">
                                    <span class="text-3xl font-bold text-gray-900">$10</span>
                                    <span class="text-gray-500">/Â§©</span>
                                </div>
                                <div class="text-sm text-gray-600">ËÆ¢ÈòÖÊó∂ÈïøÔºö1‰∏™Êúà</div>
                            </div>
                        </button>

                        <!-- ÊØèÊúàÊ†áÂáÜÁâà -->
                        <button onclick="applyTemplate('monthly', 100, 12)"
                            class="group relative p-6 border-2 border-gray-200 rounded-2xl hover:border-purple-500 hover:shadow-lg transition-all text-left overflow-hidden">
                            <div
                                class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-500/10 to-transparent rounded-bl-full transform translate-x-8 -translate-y-8">
                            </div>
                            <div class="relative">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-gray-900 text-lg">ÊØèÊúàÊ†áÂáÜÁâà</div>
                                            <div class="text-xs text-gray-500">ÈÄÇÂêàÂõ¢Èòü‰ΩøÁî®</div>
                                        </div>
                                    </div>
                                    <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                        <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex items-baseline gap-2 mb-2">
                                    <span class="text-3xl font-bold text-gray-900">$100</span>
                                    <span class="text-gray-500">/Êúà</span>
                                </div>
                                <div class="text-sm text-gray-600">ËÆ¢ÈòÖÊó∂ÈïøÔºö12‰∏™ÊúàÔºà1Âπ¥Ôºâ</div>
                            </div>
                        </button>

                        <!-- ÊØèÊúà‰ºÅ‰∏öÁâà -->
                        <button onclick="applyTemplate('monthly', 200, 12)"
                            class="group relative p-6 border-2 border-gray-200 rounded-2xl hover:border-purple-500 hover:shadow-lg transition-all text-left overflow-hidden">
                            <div
                                class="absolute top-2 right-2 px-2 py-1 bg-gradient-to-r from-yellow-400 to-orange-400 text-white text-xs font-bold rounded-full">
                                Êé®Ëçê</div>
                            <div
                                class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-purple-500/10 to-transparent rounded-bl-full transform translate-x-8 -translate-y-8">
                            </div>
                            <div class="relative">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-12 h-12 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-xl flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-gray-900 text-lg">ÊØèÊúà‰ºÅ‰∏öÁâà</div>
                                            <div class="text-xs text-gray-500">ÈÄÇÂêà‰ºÅ‰∏ö‰ΩøÁî®</div>
                                        </div>
                                    </div>
                                    <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                        <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex items-baseline gap-2 mb-2">
                                    <span class="text-3xl font-bold text-gray-900">$200</span>
                                    <span class="text-gray-500">/Êúà</span>
                                </div>
                                <div class="text-sm text-gray-600">ËÆ¢ÈòÖÊó∂ÈïøÔºö12‰∏™ÊúàÔºà1Âπ¥Ôºâ</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-200"></div>
                    </div>
                    <div class="relative flex justify-center">
                        <span class="px-4 bg-white text-sm text-gray-500">ÊàñËá™ÂÆö‰πâÈÖçÁΩÆ</span>
                    </div>
                </div>

                <!-- Ëá™ÂÆö‰πâÈÖçÁΩÆ -->
                <div class="space-y-6">
                    <!-- ËÆ¢ÈòÖÁ±ªÂûã -->
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-sm">2</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">ÈÄâÊã©ËÆ¢ÈòÖÁ±ªÂûã</h3>
                            <span class="text-red-500">*</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="relative group cursor-pointer">
                                <input type="radio" name="sub-type-radio" value="daily"
                                    onchange="updateSubscriptionType('daily')" class="sr-only peer">
                                <div
                                    class="p-6 border-2 border-gray-200 rounded-2xl peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all hover:border-blue-300">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div
                                            class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900">ÊØèÊó•ÈáçÁΩÆ</div>
                                            <div class="text-xs text-gray-500">Daily Reset</div>
                                        </div>
                                        <div
                                            class="w-6 h-6 border-2 border-gray-300 rounded-full peer-checked:border-blue-500 peer-checked:bg-blue-500 flex items-center justify-center transition-all">
                                            <svg class="w-4 h-4 text-white opacity-0 peer-checked:opacity-100"
                                                fill="currentColor" viewBox="0 0 12 12">
                                                <path d="M10 3L4.5 8.5L2 6" />
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600">ÊØè24Â∞èÊó∂Ëá™Âä®ÂÖÖÂÄº‰∏ÄÊ¨°ÔºåÈÄÇÂêàÈúÄË¶ÅÊØèÊó•Á®≥ÂÆöÈ¢ùÂ∫¶ÁöÑÂú∫ÊôØ</p>
                                </div>
                            </label>
                            <label class="relative group cursor-pointer">
                                <input type="radio" name="sub-type-radio" value="monthly"
                                    onchange="updateSubscriptionType('monthly')" class="sr-only peer">
                                <div
                                    class="p-6 border-2 border-gray-200 rounded-2xl peer-checked:border-purple-500 peer-checked:bg-purple-50 transition-all hover:border-purple-300">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div
                                            class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-semibold text-gray-900">ÊØèÊúàÈáçÁΩÆ</div>
                                            <div class="text-xs text-gray-500">Monthly Reset</div>
                                        </div>
                                        <div
                                            class="w-6 h-6 border-2 border-gray-300 rounded-full peer-checked:border-purple-500 peer-checked:bg-purple-500 flex items-center justify-center transition-all">
                                            <svg class="w-4 h-4 text-white opacity-0 peer-checked:opacity-100"
                                                fill="currentColor" viewBox="0 0 12 12">
                                                <path d="M10 3L4.5 8.5L2 6" />
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600">ÊØèÊúàËá™Âä®ÂÖÖÂÄº‰∏ÄÊ¨°ÔºåÈÄÇÂêàÊåâÊúàËÆ°Ë¥πÁöÑÈïøÊúüËÆ¢ÈòÖ</p>
                                </div>
                            </label>
                        </div>
                        <input type="hidden" id="sub-type" value="">
                    </div>

                    <!-- ÂÖÖÂÄºÈ¢ùÂ∫¶ -->
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-sm">3</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">ËÆæÁΩÆÂÖÖÂÄºÈ¢ùÂ∫¶</h3>
                            <span class="text-red-500">*</span>
                        </div>
                        <div class="relative">
                            <div class="absolute left-5 top-1/2 -translate-y-1/2 text-gray-400 text-xl font-semibold">$
                            </div>
                            <input type="number" step="0.01" id="sub-quota" placeholder="0.00"
                                onchange="updatePreview()"
                                class="w-full pl-12 pr-6 py-4 border-2 border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-2xl font-semibold text-gray-900 transition-all">
                        </div>
                        <p class="text-sm text-gray-500 mt-2 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            ÊØèÊ¨°ÈáçÁΩÆÊó∂Ëá™Âä®ÂÖÖÂÄºÂà∞Áî®Êà∑‰ΩôÈ¢ù
                        </p>
                    </div>

                    <!-- ËÆ¢ÈòÖÊó∂Èïø -->
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <div
                                class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-sm">4</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">ÈÄâÊã©ËÆ¢ÈòÖÊó∂Èïø</h3>
                            <span class="text-red-500">*</span>
                        </div>
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <button type="button" onclick="setDuration(1)"
                                class="duration-btn group p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all">
                                <div class="text-2xl font-bold text-gray-900 mb-1">1</div>
                                <div class="text-xs text-gray-500 group-hover:text-purple-600">‰∏™Êúà</div>
                            </button>
                            <button type="button" onclick="setDuration(3)"
                                class="duration-btn group p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all">
                                <div class="text-2xl font-bold text-gray-900 mb-1">3</div>
                                <div class="text-xs text-gray-500 group-hover:text-purple-600">‰∏™Êúà</div>
                            </button>
                            <button type="button" onclick="setDuration(6)"
                                class="duration-btn group p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all">
                                <div class="text-2xl font-bold text-gray-900 mb-1">6</div>
                                <div class="text-xs text-gray-500 group-hover:text-purple-600">‰∏™Êúà</div>
                            </button>
                            <button type="button" onclick="setDuration(12)"
                                class="duration-btn group p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all">
                                <div class="text-2xl font-bold text-gray-900 mb-1">12</div>
                                <div class="text-xs text-gray-500 group-hover:text-purple-600">‰∏™Êúà ¬∑ 1Âπ¥</div>
                            </button>
                        </div>
                        <div class="relative">
                            <input type="number" id="sub-duration" placeholder="ÊàñËæìÂÖ•Ëá™ÂÆö‰πâÊúàÊï∞" onchange="updatePreview()"
                                class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg transition-all">
                            <span class="absolute right-6 top-1/2 -translate-y-1/2 text-gray-400 font-medium">‰∏™Êúà</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            ÊåâËá™ÁÑ∂ÊúàËÆ°ÁÆóÔºå‰æãÂ¶Ç2Êúà10Êó•ÂºÄÈÄö1‰∏™ÊúàÔºåÂà∞ÊúüÊó•‰∏∫3Êúà10Êó•Ôºà2ÊúàÂè™Êúâ28Â§©‰πüÊòØ3Êúà10Êó•Ôºâ
                        </p>
                    </div>

                    <!-- È¢ÑËßà‰ø°ÊÅØ -->
                    <div id="subscription-preview" class="hidden">
                        <div
                            class="bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 border-2 border-green-200 rounded-2xl p-6 shadow-lg">
                            <div class="flex items-start gap-4">
                                <div
                                    class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="text-lg font-semibold text-gray-900 mb-4">ËÆ¢ÈòÖÈ¢ÑËßà</div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-white/60 backdrop-blur-sm rounded-xl p-4">
                                            <div class="text-xs text-gray-600 mb-1">ËÆ¢ÈòÖÁ±ªÂûã</div>
                                            <div class="text-lg font-semibold text-gray-900" id="preview-type">-</div>
                                        </div>
                                        <div class="bg-white/60 backdrop-blur-sm rounded-xl p-4">
                                            <div class="text-xs text-gray-600 mb-1">ÂÖÖÂÄºÈ¢ùÂ∫¶</div>
                                            <div class="text-lg font-semibold text-green-600" id="preview-quota">-</div>
                                        </div>
                                        <div class="bg-white/60 backdrop-blur-sm rounded-xl p-4">
                                            <div class="text-xs text-gray-600 mb-1">ËÆ¢ÈòÖÊó∂Èïø</div>
                                            <div class="text-lg font-semibold text-gray-900" id="preview-duration">-
                                            </div>
                                        </div>
                                        <div class="bg-white/60 backdrop-blur-sm rounded-xl p-4">
                                            <div class="text-xs text-gray-600 mb-1">Âà∞ÊúüÊó•Êúü</div>
                                            <div class="text-lg font-semibold text-purple-600" id="preview-expires">-
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-green-200">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-600">È¢ÑËÆ°ÊÄªÂÖÖÂÄº</span>
                                            <span class="text-2xl font-bold text-blue-600" id="preview-total">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="border-t border-gray-200 bg-gray-50 p-6">
                <div class="flex items-center justify-between gap-4">
                    <button onclick="cancelSubscription()"
                        class="px-5 py-2.5 bg-white border-2 border-red-200 text-red-600 rounded-xl font-medium hover:bg-red-50 hover:border-red-300 transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        ÂèñÊ∂àËÆ¢ÈòÖ
                    </button>
                    <div class="flex gap-3">
                        <button onclick="hideModal('subscriptionModal')"
                            class="px-6 py-2.5 bg-white border-2 border-gray-200 rounded-xl font-medium text-gray-600 hover:bg-gray-100 transition-all">
                            ÂèñÊ∂à
                        </button>
                        <button onclick="setSubscription()"
                            class="px-8 py-2.5 bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 hover:from-purple-700 hover:via-indigo-700 hover:to-blue-700 text-white rounded-xl font-semibold transition-all flex items-center gap-2 shadow-lg shadow-purple-500/30">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                            Á°ÆËÆ§ËÆæÁΩÆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂØºÂÖ•ÂºπÁ™ó -->
    <div id="importModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl mx-4 animate-scaleIn max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900">ÊâπÈáèÂØºÂÖ•Ë¥¶Âè∑</h3>
                <button onclick="hideModal('importModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="import-input-section">
                    <!-- Ê®°ÊùøÊåâÈíÆ -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">Âø´ÈÄüÊ®°Êùø</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="loadTemplate('social')"
                                class="px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                </svg>
                                Social Ê®°Êùø
                            </button>
                            <button onclick="loadTemplate('builderid')"
                                class="px-3 py-2 bg-purple-50 hover:bg-purple-100 text-purple-600 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                </svg>
                                BuilderId Ê®°Êùø
                            </button>
                            <button onclick="loadTemplate('enterprise')"
                                class="px-3 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg text-sm font-medium transition flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                </svg>
                                Enterprise Ê®°Êùø
                            </button>
                        </div>
                    </div>

                    <!-- Êñá‰ª∂ÈÄâÊã© -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">ÈÄâÊã©Êñá‰ª∂</p>
                        <input type="file" id="import-file" accept=".json" class="hidden"
                            onchange="handleFileSelect(event)">
                        <button onclick="document.getElementById('import-file').click()"
                            class="w-full bg-blue-50 hover:bg-blue-100 text-blue-600 border-2 border-dashed border-blue-200 rounded-lg py-3 text-sm font-medium transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            ÈÄâÊã© JSON Êñá‰ª∂
                        </button>
                        <div id="file-name" class="text-sm text-gray-500 mt-2"></div>
                    </div>

                    <div class="text-center text-gray-400 text-sm my-3">‚Äî ÊàñÁ≤òË¥¥ JSON ‚Äî</div>

                    <!-- JSON ËæìÂÖ• -->
                    <div class="mb-4">
                        <textarea id="import-json" placeholder='Á≤òË¥¥ JSON ÂÜÖÂÆπÔºå‰æãÂ¶ÇÔºö
[
  {
    "name": "Ë¥¶Âè∑1",
    "refreshToken": "aor...",
    "authMethod": "social"
  },
  {
    "name": "Ë¥¶Âè∑2",
    "refreshToken": "aor...",
    "authMethod": "idc",
    "clientId": "xxx",
    "clientSecret": "xxx",
    "region": "us-east-1"
  }
]' rows="10" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none text-sm font-mono"></textarea>
                    </div>

                    <!-- Ê†ºÂºèËØ¥Êòé -->
                    <div class="bg-gray-50 rounded-lg p-4 text-sm">
                        <p class="font-medium text-gray-700 mb-2">Ê†ºÂºèËØ¥ÊòéÔºö</p>
                        <ul class="text-gray-600 space-y-1 text-xs">
                            <li><strong>Social Ë¥¶Âè∑</strong>ÔºöÈúÄË¶Å name, refreshToken, authMethod: "social"</li>
                            <li><strong>IdC Ë¥¶Âè∑</strong>ÔºöÈúÄË¶Å name, refreshToken, authMethod: "idc", clientId,
                                clientSecret, region</li>
                            <li>ÊâÄÊúâ refreshToken ÂøÖÈ°ª‰ª• "aor" ÂºÄÂ§¥</li>
                            <li>ÊîØÊåÅÂçï‰∏™ÂØπË±°ÊàñÊï∞ÁªÑÊ†ºÂºè</li>
                        </ul>
                    </div>
                </div>

                <div id="import-result-section" class="hidden space-y-4">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl p-4">
                        <div class="flex items-center justify-between gap-3 mb-3">
                            <h4 class="text-base font-semibold text-gray-900">ÂØºÂÖ•ÁªìÊûú</h4>
                            <span id="import-result-status"
                                class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">Â§ÑÁêÜ‰∏≠</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div class="bg-white rounded-lg p-3 border border-gray-100">
                                <div class="text-xs text-gray-500">ÊÄªËÆ°</div>
                                <div id="import-total-count" class="text-lg font-semibold text-gray-900">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-green-100">
                                <div class="text-xs text-green-600">ÊàêÂäü</div>
                                <div id="import-success-count" class="text-lg font-semibold text-green-700">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-red-100">
                                <div class="text-xs text-red-600">Â§±Ë¥•</div>
                                <div id="import-failed-count" class="text-lg font-semibold text-red-700">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-indigo-100">
                                <div class="text-xs text-indigo-600">IdC/BuilderId/Enterprise</div>
                                <div id="import-idc-count" class="text-lg font-semibold text-indigo-700">0</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-sky-100">
                                <div class="text-xs text-sky-600">Social</div>
                                <div id="import-social-count" class="text-lg font-semibold text-sky-700">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <h5 class="text-sm font-semibold text-gray-800 mb-3">ÊàêÂäüË¥¶Âè∑Á±ªÂûãÊòéÁªÜ</h5>
                        <div id="import-success-list" class="space-y-2 text-sm text-gray-600"></div>
                    </div>

                    <div id="import-failed-block" class="hidden bg-red-50 border border-red-100 rounded-xl p-4">
                        <h5 class="text-sm font-semibold text-red-700 mb-3">Â§±Ë¥•ËØ¶ÊÉÖ</h5>
                        <div id="import-failed-list" class="space-y-2 text-sm text-red-600"></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-100">
                <button id="import-reset-btn" onclick="resetImportResultView(true)"
                    class="hidden px-4 py-2 border border-indigo-200 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100 transition">ÁªßÁª≠ÂØºÂÖ•</button>
                <button onclick="hideModal('importModal')"
                    class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition">ÂèñÊ∂à</button>
                <button id="import-submit-btn" onclick="importAccounts()"
                    class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    ÂºÄÂßãÂØºÂÖ•
                </button>
            </div>
        </div>
    </div>

    <div id="permissionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl animate-scaleIn overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-gray-100">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Áî®Êà∑ÊùÉÈôêÁÆ°ÁêÜ</h3>
                    <p class="text-sm text-gray-500 mt-1" id="permission-username">-</p>
                </div>
                <button onclick="hideModal('permissionModal')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 space-y-5">
                <div>
                    <div class="text-sm font-medium text-gray-700 mb-2">Ê∏†ÈÅìÊùÉÈôê</div>
                    <div class="flex items-center gap-4 flex-wrap">
                        <label
                            class="inline-flex items-center gap-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-50 px-2 py-1 rounded transition">
                            <input type="checkbox" name="perm-channel" value="kiro" id="perm-channel-kiro"
                                class="rounded border-gray-300 text-blue-500 focus:ring-blue-500 channel-checkbox">
                            <span class="font-medium">Kiro</span>
                        </label>
                        <label
                            class="inline-flex items-center gap-2 text-sm text-gray-700 cursor-pointer hover:bg-gray-50 px-2 py-1 rounded transition">
                            <input type="checkbox" name="perm-channel" value="agt" id="perm-channel-agt"
                                class="rounded border-gray-300 text-indigo-500 focus:ring-indigo-500 channel-checkbox">
                            <span class="font-medium">AGT</span>
                        </label>
                    </div>
                </div>
                <div>
                    <div class="text-sm font-medium text-gray-700 mb-2">Ê®°ÂûãÁôΩÂêçÂçïÔºàÂèØÈÄâÔºâ</div>
                    <div id="perm-models-container"
                        class="max-h-[60vh] overflow-y-auto border border-gray-200 rounded-xl bg-gray-50/50 p-4 space-y-4">
                        <!-- Âä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 flex items-start gap-2">
                    <svg class="w-4 h-4 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="text-xs text-blue-700 leading-relaxed">
                        <span class="font-semibold">ËØ¥ÊòéÔºö</span>
                        <ul class="list-disc list-inside mt-1 space-y-0.5">
                            <li>ÂãæÈÄâÊ∏†ÈÅìÂêéÔºåËØ•Ê∏†ÈÅìÁöÑÊ®°ÂûãÈÖçÁΩÆÊâç‰ºöÁîüÊïà„ÄÇ</li>
                            <li>Ëã•ÊüêÊ∏†ÈÅì‰∏ã<strong>Êú™ÂãæÈÄâ‰ªª‰ΩïÊ®°Âûã</strong>ÔºåÂàôËØ•Ê∏†ÈÅìÊâÄÊúâÊ®°ÂûãÂùáÂèØÁî®ÔºàÈªëÂêçÂçïÊ®°ÂºèÔºâ„ÄÇ</li>
                            <li>Kiro Ê∏†ÈÅìÈªòËÆ§ÂºÄÂêØ„ÄÇ</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 p-6 border-t border-gray-100">
                <button onclick="hideModal('permissionModal')"
                    class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50 transition">ÂèñÊ∂à</button>
                <button onclick="saveUserPermissions()"
                    class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg text-sm font-medium transition">‰øùÂ≠òÊùÉÈôê</button>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('kiro_token');
        let adminKey = token || '';
        let selectedAccounts = new Set();
        let selectedAgtAccounts = new Set();
        let autoRefreshInterval = null;
        let serverStartTime = null;
        let uptimeInterval = null;
        let currentRechargeUserId = null;
        let currentPage = 1;
        let pageSize = 15;
        let allAccounts = [];
        let weeklyChart = null;
        let usersCurrentPage = 1;
        let usersPageSize = 15;
        let allUsers = [];
        let allAgtAccounts = [];
        let logsCurrentPage = 1;
        let logsPageSize = 20;
        let allLogs = [];

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-yellow-500' };
            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium animate-slideIn`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('animate-slideOut'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            if (toggle.checked) {
                autoRefreshInterval = setInterval(() => {
                    loadLogs();
                }, 5000);
                showToast('Â∑≤ÂºÄÂêØËá™Âä®Âà∑Êñ∞', 'success');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                showToast('Â∑≤ÂÖ≥Èó≠Ëá™Âä®Âà∑Êñ∞', 'info');
            }
        }

        function startUptimeCounter() {
            if (uptimeInterval) {
                clearInterval(uptimeInterval);
            }
            uptimeInterval = setInterval(() => {
                if (serverStartTime) {
                    const uptime = Math.floor((Date.now() - serverStartTime) / 1000);
                    const uptimeEl = document.getElementById('stat-uptime');
                    if (uptimeEl) {
                        uptimeEl.textContent = formatUptime(uptime);
                    }
                }
            }, 1000);
        }

        async function fetchApi(url, options = {}) {
            const res = await fetch(url, { ...options, headers: { 'Content-Type': 'application/json', 'x-admin-key': adminKey, ...options.headers } });
            if (res.status === 401) { logout(); throw new Error('ËÆ§ËØÅÂ§±Ë¥•'); }
            if (!res.ok && res.status !== 204) {
                const error = await res.json().catch(() => ({}));
                const err = new Error(error.error?.message || res.statusText);
                err.status = res.status;
                err.payload = error;
                throw err;
            }
            return res.status === 204 ? null : res.json();
        }

        function logout() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (uptimeInterval) clearInterval(uptimeInterval);
            localStorage.removeItem('kiro_token');
            localStorage.removeItem('kiro_user');
            window.location.href = '/login.html';
        }

        function showMainPanel() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPanel').classList.remove('hidden');
            refresh();
        }

        function formatUptime(secs) {
            const h = Math.floor(secs / 3600), m = Math.floor((secs % 3600) / 60);
            return h > 0 ? `${h}h ${m}m` : `${m}m ${secs % 60}s`;
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
        }

        async function loadStatus() {
            try {
                const data = await fetchApi('/api/admin/stats/overview');
                const stats = data.data;

                // Kiro accounts stats
                document.getElementById('stat-active').textContent = stats.kiroAccounts?.active || 0;
                document.getElementById('stat-cooldown').textContent = stats.kiroAccounts?.cooldown || 0;
                const invalidCount = (stats.kiroAccounts?.error || 0) + (stats.kiroAccounts?.depleted || 0) + (stats.kiroAccounts?.disabled || 0) + (stats.kiroAccounts?.inactive || 0);
                document.getElementById('stat-invalid').textContent = invalidCount;

                // Request stats
                document.getElementById('stat-requests').textContent = formatNumber(stats.allTime?.requests || 0);
                document.getElementById('stat-input').textContent = formatNumber(stats.allTime?.inputTokens || 0);
                document.getElementById('stat-output').textContent = formatNumber(stats.allTime?.outputTokens || 0);

                // ‰ªäÊó•ÁªüËÆ°
                document.getElementById('today-requests').textContent = formatNumber(stats.today?.requests || 0);
                document.getElementById('today-revenue').textContent = '$' + (stats.today?.revenue || 0).toFixed(2);
                document.getElementById('today-input').textContent = formatNumber(stats.today?.inputTokens || 0);
                document.getElementById('today-output').textContent = formatNumber(stats.today?.outputTokens || 0);

                // ËÆ°ÁÆóË¥¶Âè∑Ê±†ÊÄªÈ¢ùÂ∫¶
                await loadQuotaStats();

                // Âä†ËΩΩ7Â§©Ë∂ãÂäøÂõæ
                await loadWeeklyChart();

                // Uptime - ÂêØÂä®Ëá™Âä®Êõ¥Êñ∞
                if (!serverStartTime) {
                    serverStartTime = Date.now();
                }
                startUptimeCounter();
            } catch (e) {
                console.error('Load status error:', e);
            }
        }

        async function loadQuotaStats() {
            try {
                const data = await fetchApi('/api/admin/accounts');
                const accounts = data.data || [];

                let totalQuota = 0;
                let totalUsed = 0;
                let totalAvailable = 0;

                accounts.forEach(acc => {
                    if (acc.usage_limit && acc.status === 'active') {
                        totalQuota += acc.usage_limit || 0;
                        totalUsed += acc.current_usage || 0;
                        totalAvailable += acc.available || 0;
                    }
                });

                const usedPercent = totalQuota > 0 ? Math.round((totalUsed / totalQuota) * 100) : 0;

                document.getElementById('stat-total-quota').textContent = totalQuota.toFixed(1);
                document.getElementById('stat-available-quota').textContent = totalAvailable.toFixed(1);
                document.getElementById('stat-used-percent').textContent = usedPercent + '%';
                document.getElementById('quota-progress').style.width = usedPercent + '%';
            } catch (e) {
                console.error('Load quota stats error:', e);
            }
        }

        async function loadWeeklyChart() {
            try {
                // Ëé∑ÂèñÊúÄËøë7Â§©ÁöÑÊï∞ÊçÆ
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 6);

                const labels = [];
                const requestData = [];

                // ÊåâÊó•ÊúüÂàÜÁªÑÁªüËÆ°
                const dailyStats = {};
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push((date.getMonth() + 1) + '/' + date.getDate());
                    dailyStats[dateStr] = 0;
                }

                // ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊúÄËøë7Â§©ÁöÑÊó•ÂøóÁªüËÆ°ÔºàÂè™Ëé∑ÂèñÊúÄËøë7Â§©ÁöÑÊï∞ÊçÆÔºâ
                const startDateStr = startDate.toISOString();
                const endDateStr = endDate.toISOString();
                const logsData = await fetchApi(`/api/admin/logs?limit=1000&startDate=${startDateStr}&endDate=${endDateStr}`);
                const logs = logsData.data || [];

                // ÁªüËÆ°ÊØèÂ§©ÁöÑËØ∑Ê±ÇÊï∞
                logs.forEach(log => {
                    const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                    if (dailyStats.hasOwnProperty(logDate)) {
                        dailyStats[logDate]++;
                    }
                });

                // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                Object.keys(dailyStats).sort().forEach(date => {
                    requestData.push(dailyStats[date]);
                });

                // Â¶ÇÊûúÂõæË°®Â∑≤Â≠òÂú®ÔºåÂè™Êõ¥Êñ∞Êï∞ÊçÆÔºå‰∏çÈáçÊñ∞ÂàõÂª∫
                if (weeklyChart) {
                    weeklyChart.data.labels = labels;
                    weeklyChart.data.datasets[0].data = requestData;
                    weeklyChart.update('none'); // 'none' Ê®°Âºè‰∏ç‰ΩøÁî®Âä®ÁîªÔºåÈÅøÂÖçÂç°È°ø
                } else {
                    // È¶ñÊ¨°ÂàõÂª∫ÂõæË°®
                    const ctx = document.getElementById('weeklyChart').getContext('2d');
                    weeklyChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'ËØ∑Ê±ÇÊï∞',
                                data: requestData,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: false, // Á¶ÅÁî®Âä®ÁîªÔºåÊèêÂçáÊÄßËÉΩ
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 0,
                                        autoSkip: false
                                    }
                                }
                            },
                            layout: {
                                padding: 0
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Load weekly chart error:', e);
            }
        }

        async function loadAccounts() {
            try {
                const data = await fetchApi('/api/admin/accounts');
                allAccounts = data.data || [];
                renderAccountsPage();
            } catch (e) { console.error(e); }
        }

        async function loadAgtAccounts() {
            try {
                const data = await fetchApi('/api/admin/agt-accounts');
                allAgtAccounts = data.data || [];
                renderAgtAccounts();
            } catch (e) {
                showToast('Âä†ËΩΩ AGT Ë¥¶Âè∑Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        function renderAgtAccounts() {
            const container = document.getElementById('agt-accounts-table');
            if (!container) return;
            if (!allAgtAccounts.length) {
                container.innerHTML = '<div class="text-center py-10 text-gray-500">ÊöÇÊó† AGT Ë¥¶Âè∑</div>';
                return;
            }

            container.innerHTML = `
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <th class="px-4 py-3 rounded-tl-lg w-10"><input type="checkbox" id="selectAllAgt" onchange="toggleSelectAllAgt(this.checked)" class="rounded border-gray-300 text-indigo-500 focus:ring-indigo-500"></th>
                            <th class="px-4 py-3">ÂêçÁß∞</th>
                            <th class="px-4 py-3">Áä∂ÊÄÅ</th>
                            <th class="px-4 py-3 w-72">È¢ùÂ∫¶</th>
                            <th class="px-4 py-3">ËØ∑Ê±Ç</th>
                            <th class="px-4 py-3">ÈîôËØØ</th>
                            <th class="px-4 py-3 rounded-tr-lg">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${allAgtAccounts.map((a, i) => `
                            <tr class="hover:bg-gray-50 transition ${i % 2 === 1 ? 'bg-gray-50/50' : ''}">
                                <td class="px-4 py-4"><input type="checkbox" data-id="${a.id}" onchange="toggleSelectAgt('${a.id}', this.checked)" class="agt-account-checkbox rounded border-gray-300 text-indigo-500 focus:ring-indigo-500"></td>
                                <td class="px-4 py-4">
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="font-medium text-gray-900">${a.name || '-'}</div>
                                        ${formatAgtTierBadge(a.paid_tier || a.plan_tier)}
                                    </div>
                                </td>
                                <td class="px-4 py-4">${formatStatus(a.status)}</td>
                                <td class="px-4 py-4">
                                    <div class="space-y-2 text-xs">
                                        ${formatAgtQuotaDetails(a.model_quotas, a.next_reset)}
                                    </div>
                                </td>
                                <td class="px-4 py-4 text-gray-600">${a.request_count || 0}</td>
                                <td class="px-4 py-4 text-gray-600">${a.error_count || 0}</td>
                                <td class="px-4 py-4">
                                    <div class="flex items-center gap-2">
                                        <button onclick="refreshAgtUsage('${a.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition" title="Âà∑Êñ∞È¢ùÂ∫¶">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                        </button>
                                        <button onclick="exportAccountJson('${a.id}')" class="p-1.5 text-purple-600 hover:bg-purple-50 rounded transition" title="ÂØºÂá∫JSON">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                        </button>
                                        ${a.status === 'disabled'
                    ? `<button onclick="toggleAgtAccount('${a.id}', true)" class="p-1.5 text-green-600 hover:bg-green-50 rounded transition" title="ÂêØÁî®">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                              </button>`
                    : `<button onclick="toggleAgtAccount('${a.id}', false)" class="p-1.5 text-orange-600 hover:bg-orange-50 rounded transition" title="Á¶ÅÁî®">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                                              </button>`}
                                        <button onclick="removeAgtAccount('${a.id}')" class="p-1.5 text-red-600 hover:bg-red-50 rounded transition" title="Âà†Èô§">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
        }

        function formatAgtTierBadge(tier) {
            if (!tier) return '';
            const normalized = String(tier).toLowerCase();
            let label = tier;
            let color = 'bg-gray-100 text-gray-700 border-gray-200';

            if (normalized.includes('ultra') || normalized.includes('power')) {
                label = 'Power';
                color = 'bg-amber-100 text-amber-700 border-amber-300';
            } else if (normalized.includes('proplus') || normalized.includes('pro+')) {
                label = 'Pro+';
                color = 'bg-purple-100 text-purple-700 border-purple-300';
            } else if (normalized.includes('pro') || normalized.includes('standard')) {
                label = 'Pro';
                color = 'bg-blue-100 text-blue-700 border-blue-300';
            } else if (normalized.includes('free')) {
                label = 'Free';
                color = 'bg-gray-100 text-gray-700 border-gray-300';
            }

            return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold border ${color}" title="Êù•Ê∫ê: ${tier}">${label}</span>`;
        }

        function formatAgtNextResetBadge(nextReset) {
            if (!nextReset) return '';
            return formatResetTimeBadge(nextReset);
        }

        function formatAgtQuotaSummary(modelQuotas) {
            const quotas = modelQuotas && typeof modelQuotas === 'object' ? modelQuotas : null;
            if (!quotas) return '<span class="text-gray-400">Êú™ÂêåÊ≠•</span>';

            const entries = Object.entries(quotas);
            if (!entries.length) return '<span class="text-gray-400">Êó†Ê®°ÂûãÈÖçÈ¢ù</span>';

            let availableCount = 0;
            let exhaustedCount = 0;
            for (const [, quota] of entries) {
                const remaining = Number(quota?.remaining_fraction);
                if (Number.isFinite(remaining) && remaining > 0) {
                    availableCount += 1;
                } else {
                    exhaustedCount += 1;
                }
            }

            return `<div class="space-y-0.5"><div>Ê®°Âûã: ${entries.length}</div><div class="text-green-600">ÂèØÁî®: ${availableCount}</div><div class="text-red-500">ËÄóÂ∞Ω: ${exhaustedCount}</div></div>`;
        }

        function formatAgtQuotaDetails(modelQuotas, nextReset) {
            const quotas = modelQuotas && typeof modelQuotas === 'object' ? modelQuotas : null;
            if (!quotas) return '<span class="text-gray-400">Êú™ÂêåÊ≠•</span>';

            const entries = Object.entries(quotas);
            if (!entries.length) return '<span class="text-gray-400">Êó†Ê®°ÂûãÈÖçÈ¢ù</span>';

            let resetInfo = '';
            if (nextReset) {
                const resetTime = new Date(nextReset);
                const now = new Date();
                const diffMs = resetTime - now;
                if (diffMs > 0) {
                    const hours = Math.floor(diffMs / (1000 * 60 * 60));
                    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    resetInfo = `<div class="text-gray-500 mb-1.5">üîÑ ${hours}h ${minutes}m ÂêéÈáçÁΩÆ</div>`;
                }
            }

            const bars = entries.map(([modelName, quota]) => {
                const remaining = Number(quota?.remaining_fraction) || 0;
                const percentage = Math.round(remaining * 100);

                let barColor = 'bg-red-500';
                let textColor = 'text-red-600';
                if (percentage > 50) {
                    barColor = 'bg-green-500';
                    textColor = 'text-green-600';
                } else if (percentage >= 20) {
                    barColor = 'bg-yellow-500';
                    textColor = 'text-yellow-600';
                }

                const displayName = modelName
                    .replace('claude-sonnet-', 'CS-')
                    .replace('claude-opus-', 'CO-')
                    .replace('gemini-', 'G-')
                    .replace('-thinking', '-T');

                return `
                    <div class="flex items-center gap-2">
                        <div class="w-32 text-gray-600 truncate text-xs" title="${modelName}">${modelName}</div>
                        <div class="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div class="${barColor} h-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                        <div class="w-10 text-right ${textColor} font-medium text-xs">${percentage}%</div>
                    </div>
                `;
            }).join('');

            return resetInfo + bars;
        }

        function loadAgtTemplate() {
            const template = JSON.stringify({
                type: 'antigravity',
                email: 'user@example.com',
                project_id: 'your-project-id',
                access_token: 'ya29.xxxxx',
                refresh_token: '1//0gxxxxx',
                expires_in: 3599,
                expired: new Date(Date.now() + 3600 * 1000).toISOString(),
                timestamp: Date.now()
            }, null, 2);
            document.getElementById('agt-import-json').value = template;
        }

        async function importAgtAccounts() {
            const jsonContent = document.getElementById('agt-import-json').value.trim();
            if (!jsonContent) {
                showToast('ËØ∑ËæìÂÖ• AGT JSON ÂÜÖÂÆπ', 'warning');
                return;
            }
            try {
                JSON.parse(jsonContent);
            } catch {
                showToast('JSON Ê†ºÂºèÈîôËØØ', 'error');
                return;
            }

            try {
                const result = await fetchApi('/api/admin/agt-accounts/import', {
                    method: 'POST',
                    body: JSON.stringify({ raw_json: jsonContent })
                });
                await loadAgtAccounts();
                hideModal('agtImportModal');
                showToast(`AGT ÂØºÂÖ•ÂÆåÊàêÔºöÊàêÂäü ${result.success}ÔºåÂ§±Ë¥• ${result.failed}`, result.failed > 0 ? 'warning' : 'success');
            } catch (e) {
                showToast('AGT ÂØºÂÖ•Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function refreshAgtModels(id) {
            try {
                const result = await fetchApi(`/api/admin/agt-accounts/${id}/refresh-models`, { method: 'POST' });
                const count = Array.isArray(result?.data?.models) ? result.data.models.length : 0;
                showToast(`Â∑≤Âà∑Êñ∞Ê®°ÂûãÔºåÊï∞Èáè: ${count}`, 'success');
                await loadAgtAccounts();
            } catch (e) {
                showToast('Âà∑Êñ∞ AGT Ê®°ÂûãÂ§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function refreshAgtUsage(id) {
            try {
                const result = await fetchApi(`/api/admin/agt-accounts/${id}/refresh-usage`, { method: 'POST' });
                const projectId = result?.data?.project_id || '-';
                showToast(`AGT È¢ùÂ∫¶‰ø°ÊÅØÂ∑≤Âà∑Êñ∞ÔºåProject: ${projectId}`, 'success');
                await loadAgtAccounts();
            } catch (e) {
                showToast('Âà∑Êñ∞ AGT È¢ùÂ∫¶Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function refreshAllAgtUsage() {
            if (!allAgtAccounts.length) {
                showToast('ÊöÇÊó† AGT Ë¥¶Âè∑ÂèØÂà∑Êñ∞', 'warning');
                return;
            }

            showToast('Ê≠£Âú®Âà∑Êñ∞ AGT È¢ùÂ∫¶ÔºåËØ∑Á®çÂÄô...', 'info');
            let success = 0;

            for (const account of allAgtAccounts) {
                try {
                    await fetchApi(`/api/admin/agt-accounts/${account.id}/refresh-usage`, { method: 'POST' });
                    success += 1;
                } catch {
                }
            }

            await loadAgtAccounts();
            const failed = allAgtAccounts.length - success;
            showToast(`AGT È¢ùÂ∫¶Âà∑Êñ∞ÂÆåÊàêÔºöÊàêÂäü ${success}ÔºåÂ§±Ë¥• ${failed}`, failed > 0 ? 'warning' : 'success');
        }

        async function refreshAllAgtModels() {
            if (!allAgtAccounts.length) {
                showToast('ÊöÇÊó† AGT Ë¥¶Âè∑ÂèØÂà∑Êñ∞', 'warning');
                return;
            }

            showToast('Ê≠£Âú®Âà∑Êñ∞ AGT Ê®°ÂûãÔºåËØ∑Á®çÂÄô...', 'info');
            let success = 0;

            for (const account of allAgtAccounts) {
                try {
                    await fetchApi(`/api/admin/agt-accounts/${account.id}/refresh-models`, { method: 'POST' });
                    success += 1;
                } catch {
                }
            }

            await loadAgtAccounts();
            const failed = allAgtAccounts.length - success;
            showToast(`AGT Ê®°ÂûãÂà∑Êñ∞ÂÆåÊàêÔºöÊàêÂäü ${success}ÔºåÂ§±Ë¥• ${failed}`, failed > 0 ? 'warning' : 'success');
        }

        async function toggleAgtAccount(id, enable) {
            try {
                await fetchApi(`/api/admin/agt-accounts/${id}/${enable ? 'enable' : 'disable'}`, { method: 'POST' });
                showToast(enable ? 'AGT Ë¥¶Âè∑Â∑≤ÂêØÁî®' : 'AGT Ë¥¶Âè∑Â∑≤Á¶ÅÁî®', enable ? 'success' : 'warning');
                await loadAgtAccounts();
            } catch (e) {
                showToast((enable ? 'ÂêØÁî®' : 'Á¶ÅÁî®') + 'Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function removeAgtAccount(id) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§ AGT Ë¥¶Âè∑Ôºü')) return;
            try {
                await fetchApi(`/api/admin/agt-accounts/${id}`, { method: 'DELETE' });
                showToast('AGT Ë¥¶Âè∑Â∑≤Âà†Èô§', 'success');
                await loadAgtAccounts();
            } catch (e) {
                showToast('Âà†Èô§Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        function toggleSelectAgt(id, checked) {
            if (checked) selectedAgtAccounts.add(id);
            else selectedAgtAccounts.delete(id);
        }

        function toggleSelectAllAgt(checked) {
            document.querySelectorAll('.agt-account-checkbox').forEach(cb => {
                cb.checked = checked;
                if (checked) selectedAgtAccounts.add(cb.dataset.id);
                else selectedAgtAccounts.delete(cb.dataset.id);
            });
        }

        function renderAccountsPage() {
            const container = document.getElementById('accounts-table');
            selectedAccounts.clear();
            updateBatchDeleteBtn();

            if (allAccounts.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">ÊöÇÊó†Ë¥¶Âè∑ÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊ∑ªÂä†</div>';
                document.getElementById('accounts-pagination').classList.add('hidden');
                return;
            }

            document.getElementById('accounts-pagination').classList.remove('hidden');

            // ÂàÜÈ°µËÆ°ÁÆó
            const totalPages = Math.ceil(allAccounts.length / pageSize);
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, allAccounts.length);
            const pageAccounts = allAccounts.slice(startIdx, endIdx);

            // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
            document.getElementById('page-start').textContent = startIdx + 1;
            document.getElementById('page-end').textContent = endIdx;
            document.getElementById('total-accounts').textContent = allAccounts.length;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;

            // Ê∏≤ÊüìÈ°µÁ†Å
            renderPageNumbers(totalPages);

            // Ê∏≤ÊüìË°®Ê†º
            container.innerHTML = `
                <table class="w-full">
                    <thead>
                    <thead>
                        <tr class="bg-gray-50 text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <th class="px-4 py-3 text-left rounded-tl-lg w-10"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)" class="rounded border-gray-300 text-blue-500 focus:ring-blue-500"></th>
                            <th class="px-4 py-3 text-left">Ë¥¶Âè∑‰ø°ÊÅØ</th>
                            <th class="px-4 py-3 text-center">Áä∂ÊÄÅ</th>
                            <th class="px-4 py-3 text-center">È¢ùÂ∫¶‰ΩøÁî®</th>
                            <th class="px-4 py-3 text-center">ÁªüËÆ° (Req/Err)</th>
                            <th class="px-4 py-3 text-center rounded-tr-lg">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${pageAccounts.map((a, i) => `
                            <tr class="hover:bg-gray-50 transition group ${i % 2 === 1 ? 'bg-gray-50/50' : ''}">
                                <td class="px-4 py-4 align-top"><input type="checkbox" data-id="${a.id}" onchange="toggleSelect('${a.id}', this.checked)" class="account-checkbox rounded border-gray-300 text-blue-500 focus:ring-blue-500 mt-1"></td>
                                <td class="px-4 py-4 align-top">
                                    <div class="flex flex-col gap-1">
                                        <div class="font-semibold text-gray-900 text-sm flex items-center gap-2">
                                            <span>${a.name}</span>
                                            ${formatSubscriptionBadge(a.subscription_type)}
                                        </div>
                                        <div class="flex items-center gap-2 flex-wrap text-xs">
                                            ${formatAuthMethodBadge(a.auth_method)}
                                            ${formatMachineIdBadge(a)}
                                            ${formatResetTimeBadge(a.next_reset)}
                                        </div>
                                        ${a.user_email ? `<div class="text-xs text-gray-400 mt-0.5 flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>${a.user_email}</div>` : ''}
                                    </div>
                                </td>
                                <td class="px-4 py-4 align-top">
                                    <div class="flex justify-center">${formatStatus(a.status)}</div>
                                </td>
                                <td class="px-4 py-4 align-top">
                                    <div class="flex justify-center">${formatUsage(a)}</div>
                                </td>
                                <td class="px-4 py-4 align-top">
                                    <div class="flex flex-col items-center gap-1 text-xs">
                                        <div class="flex items-center gap-1"><span class="text-gray-500 w-8 text-right">Req:</span> <span class="font-medium text-gray-700">${a.request_count || 0}</span></div>
                                        <div class="flex items-center gap-1"><span class="text-gray-500 w-8 text-right">Err:</span> <span class="${(a.error_count || 0) > 0 ? 'text-red-600 font-medium' : 'text-gray-400'}">${a.error_count || 0}</span></div>
                                    </div>
                                </td>
                                <td class="px-4 py-4 align-top">
                                    <div class="flex items-center justify-center gap-1 opacity-80 group-hover:opacity-100 transition-opacity">
                                        <button onclick="refreshUsage('${a.id}')" class="p-1 text-blue-600 hover:bg-blue-50 rounded transition" title="Âà∑Êñ∞È¢ùÂ∫¶">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                        </button>
                                        <button onclick="exportAccountJson('${a.id}')" class="p-1 text-purple-600 hover:bg-purple-50 rounded transition" title="ÂØºÂá∫JSON">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                        </button>
                                        ${a.status === 'disabled'
                    ? `<button onclick="enableAccount('${a.id}', this)" class="p-1 text-green-600 hover:bg-green-50 rounded transition" title="ÂêØÁî®"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>`
                    : `<button onclick="disableAccount('${a.id}', this)" class="p-1 text-orange-600 hover:bg-orange-50 rounded transition" title="Á¶ÅÁî®"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg></button>`}
                                        <button onclick="removeAccount('${a.id}', ${a.request_log_count || 0})" class="p-1 rounded transition ${a.has_dependencies ? 'text-orange-600 hover:bg-orange-50' : 'text-red-600 hover:bg-red-50'}" title="${a.has_dependencies ? `Âº∫Âà∂Âà†Èô§ÔºöÂ∞ÜÂêåÊó∂Âà†Èô§${a.request_log_count || 0}Êù°ËØ∑Ê±ÇÊó•Âøó` : 'Âà†Èô§'}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
        }

        function renderPageNumbers(totalPages) {
            const container = document.getElementById('page-numbers');
            const maxVisible = 5;
            let pages = [];

            if (totalPages <= maxVisible) {
                pages = Array.from({ length: totalPages }, (_, i) => i + 1);
            } else {
                if (currentPage <= 3) {
                    pages = [1, 2, 3, 4, '...', totalPages];
                } else if (currentPage >= totalPages - 2) {
                    pages = [1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
                } else {
                    pages = [1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages];
                }
            }

            container.innerHTML = pages.map(p => {
                if (p === '...') {
                    return '<span class="px-3 py-1 text-gray-400">...</span>';
                }
                const isActive = p === currentPage;
                return `<button onclick="goToPage(${p})" class="px-3 py-1 rounded ${isActive ? 'bg-blue-500 text-white' : 'border border-gray-300 hover:bg-gray-50'} text-sm">${p}</button>`;
            }).join('');
        }

        function changePage(direction) {
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
                renderAccountsPage();
            } else if (direction === 'next') {
                const totalPages = Math.ceil(allAccounts.length / pageSize);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderAccountsPage();
                }
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderAccountsPage();
        }

        function toggleSelect(id, checked) {
            if (checked) selectedAccounts.add(id);
            else selectedAccounts.delete(id);
            updateBatchDeleteBtn();
        }

        function toggleSelectAll(checked) {
            document.querySelectorAll('.account-checkbox').forEach(cb => {
                cb.checked = checked;
                if (checked) selectedAccounts.add(cb.dataset.id);
                else selectedAccounts.delete(cb.dataset.id);
            });
            updateBatchDeleteBtn();
        }

        function updateBatchDeleteBtn() {
            const btn = document.getElementById('batchDeleteBtn');
            document.getElementById('selectedCount').textContent = selectedAccounts.size;
            btn.classList.toggle('hidden', selectedAccounts.size === 0);
        }

        async function batchDeleteAccounts() {
            if (selectedAccounts.size === 0) return;
            if (!confirm(`Á°ÆÂÆöÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedAccounts.size} ‰∏™Ë¥¶Âè∑Ôºü`)) return;
            try {
                const result = await fetchApi('/api/accounts/batch', { method: 'DELETE', body: JSON.stringify({ ids: Array.from(selectedAccounts) }) });
                showToast(`ÊàêÂäüÂà†Èô§ ${result.removed} ‰∏™Ë¥¶Âè∑`, 'success');
                refresh();
            } catch (e) { showToast('ÊâπÈáèÂà†Èô§Â§±Ë¥•: ' + e.message, 'error'); }
        }

        async function clearLogs() {
            if (!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâËØ∑Ê±ÇËÆ∞ÂΩïÔºü')) return;
            try {
                await fetchApi('/api/logs', { method: 'DELETE' });
                loadLogs();
                loadStatus();
                showToast('ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫', 'success');
            } catch (e) { showToast('Ê∏ÖÁ©∫Â§±Ë¥•: ' + e.message, 'error'); }
        }

        function formatStatus(status) {
            const styles = { active: 'bg-green-100 text-green-700', cooldown: 'bg-yellow-100 text-yellow-700', error: 'bg-red-100 text-red-700', depleted: 'bg-orange-100 text-orange-700', inactive: 'bg-gray-100 text-gray-700', disabled: 'bg-gray-100 text-gray-700' };
            return `<span class="px-2 py-1 rounded-full text-xs font-medium ${styles[status] || styles.disabled}">${status}</span>`;
        }

        function formatUserChannelBadges(channels) {
            const list = Array.isArray(channels) && channels.length > 0 ? channels : ['kiro', 'agt'];
            return list.map((channel) => {
                const label = channel === 'agt' ? 'AGT' : 'Kiro';
                const color = channel === 'agt'
                    ? 'bg-indigo-50 text-indigo-700 border-indigo-200'
                    : 'bg-blue-50 text-blue-700 border-blue-200';
                return `<span class="inline-flex items-center px-2 py-0.5 rounded text-[11px] font-medium border ${color}">${label}</span>`;
            }).join('');
        }

        function formatUsage(account) {
            if (!account) return '<span class="text-gray-400 text-sm">Êú™Áü•</span>';

            const used = account.current_usage || 0;
            const limit = account.usage_limit || 0;
            const available = account.available || 0;

            if (limit === 0) return '<span class="text-gray-400 text-sm">Êú™Áü•</span>';

            const percent = Math.round((used / limit) * 100);
            const barColor = percent > 90 ? 'bg-red-500' : percent > 70 ? 'bg-yellow-500' : 'bg-green-500';
            const textColor = percent > 90 ? 'text-red-600' : percent > 70 ? 'text-yellow-600' : 'text-green-600';

            // ËÆ¢ÈòÖÁ±ªÂûãÊ†áÁ≠æÔºàÊîæÂú®ÂêçÁß∞ÊóÅËæπÔºå‰∏çÂú®ËøôÈáåÊòæÁ§∫Ôºâ

            // Ê†ºÂºèÂåñÈáçÁΩÆÊó∂Èó¥
            let resetInfo = '';
            if (account.next_reset) {
                const resetDate = new Date(account.next_reset);
                const now = new Date();
                const diffDays = Math.ceil((resetDate - now) / (1000 * 60 * 60 * 24));
                if (diffDays > 0) {
                    resetInfo = `<div class="text-xs text-gray-400 mt-1.5">ÈáçÁΩÆ: ${diffDays}Â§©Âêé</div>`;
                } else if (diffDays === 0) {
                    resetInfo = `<div class="text-xs text-gray-400 mt-1.5">ÈáçÁΩÆ: ‰ªäÂ§©</div>`;
                } else {
                    resetInfo = `<div class="text-xs text-red-400 mt-1.5">Â∑≤ËøáÊúü</div>`;
                }
            }

            return `<div class="w-36">
                <div class="flex justify-between text-xs mb-1.5">
                    <span class="${textColor} font-medium">${available.toFixed(1)}</span>
                    <span class="text-gray-400">/ ${limit.toFixed(0)}</span>
                </div>
                <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div class="${barColor} h-full rounded-full transition-all" style="width: ${percent}%"></div>
                </div>
                <div class="text-xs text-gray-400 mt-1">${percent}% Â∑≤Áî®</div>
                ${resetInfo}
            </div>`;
        }

        function formatMachineIdBadge(account) {
            const source = account.machine_id_source || 'unavailable';
            const machineId = account.machine_id || 'N/A';

            // ÂæΩÁ´†ÈÖçÁΩÆ
            const badges = {
                explicit: {
                    label: 'ID: Expl',
                    color: 'bg-emerald-50 text-emerald-600 border-emerald-200',
                    dot: 'bg-emerald-400',
                    title: 'ÊòæÂºèÊåáÂÆö',
                    desc: 'Âá≠ÊçÆ‰∏≠Áõ¥Êé•Êèê‰æõÁöÑ machineId'
                },
                config: {
                    label: 'ID: Conf',
                    color: 'bg-sky-50 text-sky-600 border-sky-200',
                    dot: 'bg-sky-400',
                    title: 'ÈÖçÁΩÆÊåáÂÆö',
                    desc: '‰ªéÈÖçÁΩÆÊñá‰ª∂ËØªÂèñÁöÑ machineId'
                },
                derived: {
                    label: 'ID: Auto',
                    color: 'bg-amber-50 text-amber-600 border-amber-200',
                    dot: 'bg-amber-400',
                    title: 'Ëá™Âä®Ê¥æÁîü',
                    desc: '‰ªé refreshToken SHA256 Ê¥æÁîü'
                },
                unavailable: {
                    label: 'ID: None',
                    color: 'bg-slate-50 text-slate-500 border-slate-200',
                    dot: 'bg-slate-300',
                    title: 'Áº∫Â§±',
                    desc: 'Êó†Ê≥ïËé∑ÂèñÊàñÁîüÊàê machineId'
                }
            };

            const badge = badges[source] || badges.unavailable;

            return `
                <div class="relative group inline-block">
                    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-[10px] font-medium border ${badge.color} cursor-help transition hover:shadow-sm">
                        <span class="w-1.5 h-1.5 rounded-full ${badge.dot}"></span>
                        ${badge.label}
                    </span>
                    <div class="invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 absolute z-50 left-0 top-full mt-2 w-72 bg-white rounded-xl shadow-lg border border-gray-100 p-4 text-left backdrop-blur-sm ring-1 ring-black/5">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="text-xs font-bold text-gray-800 mb-0.5">Machine ID</div>
                                <div class="text-[10px] font-medium text-gray-500 uppercase tracking-wide">${badge.title} (${source})</div>
                            </div>
                            <button onclick="copyMachineId('${machineId}', event)" class="text-gray-400 hover:text-blue-600 transition p-1" title="Â§çÂà∂">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            </button>
                        </div>
                        <div class="bg-gray-50 rounded-lg px-3 py-2 mb-3 font-mono text-[10px] leading-relaxed text-gray-600 break-all border border-gray-100 select-all">
                            ${machineId}
                        </div>
                        <div class="text-[10px] text-gray-500 leading-relaxed border-t border-gray-100 pt-2">
                            ${badge.desc}
                        </div>
                    </div>
                </div>
            `;
        }

        function formatAuthMethodBadge(authMethod) {
            const method = (authMethod || 'social').toLowerCase();

            const badges = {
                social: {
                    label: 'Google',
                    icon: '<svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>',
                    color: 'bg-white text-gray-600 border-gray-200'
                },
                idc: {
                    label: 'BuilderID',
                    icon: '<svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>',
                    color: 'bg-violet-50 text-violet-600 border-violet-200'
                }
            };

            const badge = badges[method] || badges.social;

            return `
                <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full text-[10px] font-medium border ${badge.color}" title="${badge.label} ËÆ§ËØÅ">
                    ${badge.icon}
                    <span>${badge.label}</span>
                </span>
            `;
        }

        function formatResetTimeBadge(nextReset) {
            if (!nextReset) return '';

            const resetDate = new Date(nextReset);
            const now = new Date();
            const diffMs = resetDate - now;

            // Calculate days and hours
            const dayMs = 1000 * 60 * 60 * 24;
            const hourMs = 1000 * 60 * 60;

            const diffDays = Math.floor(diffMs / dayMs);
            const diffHours = Math.ceil((diffMs % dayMs) / hourMs);

            let label, color;

            if (diffMs < 0) {
                label = 'Â∑≤ËøáÊúü';
                color = 'bg-red-50 text-red-700 border-red-200';
            } else if (diffDays === 0) {
                label = `${Math.max(1, Math.ceil(diffMs / hourMs))}Â∞èÊó∂Âêé`;
                color = 'bg-orange-50 text-orange-700 border-orange-200';
            } else if (diffDays < 3) {
                label = `${diffDays}Â§© ${diffHours}Â∞èÊó∂`;
                color = 'bg-yellow-50 text-yellow-700 border-yellow-200';
            } else {
                label = `${diffDays}Â§© ${diffHours}Â∞èÊó∂`;
                color = 'bg-green-50 text-green-700 border-green-200';
            }

            return `
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium border ${color}" title="ÈáçÁΩÆÊó∂Èó¥: ${resetDate.toLocaleString('zh-CN')}">
                    <span>${label}</span>
                </span>
            `;
        }

        function copyMachineId(machineId, event) {
            event.stopPropagation();
            navigator.clipboard.writeText(machineId).then(() => {
                showToast('Machine ID Â∑≤Â§çÂà∂', 'success');
            }).catch(() => {
                showToast('Â§çÂà∂Â§±Ë¥•', 'error');
            });
        }

        function formatSubscriptionBadge(subscriptionType) {
            if (!subscriptionType) {
                return '<span class="inline-flex items-center px-1 py-0.5 rounded text-[10px] font-medium leading-none bg-gray-100 text-gray-500 border border-gray-200">Free</span>';
            }

            const tier = subscriptionType.toLowerCase().replace(/[_\s]/g, '');

            const badges = {
                free: {
                    label: 'Free',
                    color: 'bg-gray-100 text-gray-600 border-gray-200'
                },
                pro: {
                    label: 'Pro',
                    color: 'bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 border-blue-200'
                },
                'pro+': {
                    label: 'Pro+',
                    color: 'bg-gradient-to-r from-purple-50 to-pink-50 text-purple-700 border-purple-200'
                },
                proplus: {
                    label: 'Pro+',
                    color: 'bg-gradient-to-r from-purple-50 to-pink-50 text-purple-700 border-purple-200'
                },
                power: {
                    label: 'Power',
                    color: 'bg-gradient-to-r from-amber-50 to-orange-50 text-amber-700 border-amber-200'
                }
            };

            const badge = badges[tier] || badges.free;

            return `
                <span class="inline-flex items-center px-1 py-0.5 rounded text-[10px] font-medium leading-none border ${badge.color}">${badge.label}</span>
            `;
        }

        async function refreshUsage(id) {
            try {
                const response = await fetchApi(`/api/admin/accounts/${id}/refresh-usage`, { method: 'POST' });

                if (response.data) {
                    const { usage, status } = response.data;
                    const available = usage?.available || 0;
                    const usageLimit = usage?.usageLimit || 0;

                    let message = 'Âà∑Êñ∞ÊàêÂäü';
                    let type = 'success';

                    if (status === 'depleted') {
                        message = `‰ΩôÈ¢ù‰∏çË∂≥ (${available}/${usageLimit})ÔºåË¥¶Âè∑Â∑≤Ê†áËÆ∞‰∏∫ depleted`;
                        type = 'warning';
                    } else if (status === 'error') {
                        message = `Ë¥¶Âè∑ÂºÇÂ∏∏ÔºåÂ∑≤Ê†áËÆ∞‰∏∫ error`;
                        type = 'error';
                    } else if (available >= 5) {
                        message = `‰ΩôÈ¢ùÂÖÖË∂≥ (${available}/${usageLimit})`;
                    }

                    showToast(message, type);
                    await loadAccounts();
                    await loadStatus();
                }
            } catch (e) {
                showToast('Âà∑Êñ∞Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function refreshAllUsage() {
            try {
                showToast('Ê≠£Âú®Âà∑Êñ∞ÊâÄÊúâË¥¶Âè∑ÔºåËØ∑Á®çÂÄô...', 'info');

                // ËÆæÁΩÆËæÉÈïøÁöÑË∂ÖÊó∂Êó∂Èó¥Ôºà2ÂàÜÈíüÔºâ
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000);

                const response = await fetch('/api/admin/accounts/refresh-all-usage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': token
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || response.statusText);
                }

                const data = await response.json();
                loadAccounts();

                // ÁªüËÆ°ÊàêÂäüÂíåÂ§±Ë¥•ÁöÑÊï∞Èáè
                const successCount = data.data.filter(r => r.usage && !r.usage.error).length;
                const failCount = data.data.filter(r => r.usage && r.usage.error).length;

                showToast(`Âà∑Êñ∞ÂÆåÊàêÔºÅÊàêÂäü: ${successCount}, Â§±Ë¥•: ${failCount}`, 'success');
            } catch (e) {
                if (e.name === 'AbortError') {
                    showToast('Âà∑Êñ∞Ë∂ÖÊó∂ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
                } else {
                    showToast('Âà∑Êñ∞Â§±Ë¥•: ' + e.message, 'error');
                }
            }
        }

        async function loadLogs() {
            try {
                const data = await fetchApi('/api/admin/logs?limit=1000');
                allLogs = data.data || [];
                renderLogsPage();
            } catch (e) { console.error(e); }
        }

        function renderLogsPage() {
            const container = document.getElementById('logs-table');

            if (!allLogs || allLogs.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">ÊöÇÊó†ËØ∑Ê±ÇËÆ∞ÂΩï</div>';
                document.getElementById('logs-pagination').classList.add('hidden');
                return;
            }

            document.getElementById('logs-pagination').classList.remove('hidden');

            // ÂàÜÈ°µËÆ°ÁÆó
            const totalPages = Math.ceil(allLogs.length / logsPageSize);
            const startIdx = (logsCurrentPage - 1) * logsPageSize;
            const endIdx = Math.min(startIdx + logsPageSize, allLogs.length);
            const pageLogs = allLogs.slice(startIdx, endIdx);

            // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
            document.getElementById('logs-page-start').textContent = startIdx + 1;
            document.getElementById('logs-page-end').textContent = endIdx;
            document.getElementById('total-logs').textContent = allLogs.length;
            document.getElementById('logs-prev-btn').disabled = logsCurrentPage === 1;
            document.getElementById('logs-next-btn').disabled = logsCurrentPage === totalPages;

            // Ê∏≤ÊüìÈ°µÁ†Å
            renderLogsPageNumbers(totalPages);

            // Ê∏≤ÊüìË°®Ê†º
            container.innerHTML = `
                <table class="w-full">
                    <thead><tr class="bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <th class="px-4 py-3 rounded-tl-lg">Êó∂Èó¥</th><th class="px-4 py-3">Ë¥¶Âè∑</th><th class="px-4 py-3">Ê®°Âûã</th><th class="px-4 py-3">ËæìÂÖ•</th><th class="px-4 py-3">ËæìÂá∫</th><th class="px-4 py-3">ËÄóÊó∂</th><th class="px-4 py-3 rounded-tr-lg">Áä∂ÊÄÅ</th>
                    </tr></thead>
                    <tbody class="divide-y divide-gray-100">
                        ${pageLogs.map((l, i) => `<tr class="hover:bg-gray-50 transition ${i % 2 === 1 ? 'bg-gray-50/50' : ''}">
                            <td class="px-4 py-3 text-sm text-gray-600">${new Date(l.timestamp).toLocaleString()}</td>
                            <td class="px-4 py-3 text-sm text-gray-900">${l.kiro_account_name || l.accountName}</td>
                            <td class="px-4 py-3 text-xs text-gray-500">${l.model || '-'}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${l.input_tokens || l.inputTokens || 0}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${l.output_tokens || l.outputTokens || 0}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${l.duration_ms || l.durationMs}ms</td>
                            <td class="px-4 py-3">${l.success ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">ÊàêÂäü</span>' : '<span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">Â§±Ë¥•</span>'}</td>
                        </tr>`).join('')}
                    </tbody>
                </table>`;
        }

        function renderLogsPageNumbers(totalPages) {
            const container = document.getElementById('logs-page-numbers');
            const maxVisible = 5;
            let pages = [];

            if (totalPages <= maxVisible) {
                pages = Array.from({ length: totalPages }, (_, i) => i + 1);
            } else {
                if (logsCurrentPage <= 3) {
                    pages = [1, 2, 3, 4, '...', totalPages];
                } else if (logsCurrentPage >= totalPages - 2) {
                    pages = [1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
                } else {
                    pages = [1, '...', logsCurrentPage - 1, logsCurrentPage, logsCurrentPage + 1, '...', totalPages];
                }
            }

            container.innerHTML = pages.map(p => {
                if (p === '...') {
                    return '<span class="px-3 py-1 text-gray-400">...</span>';
                }
                const isActive = p === logsCurrentPage;
                return `<button onclick="goToLogsPage(${p})" class="px-3 py-1 rounded ${isActive ? 'bg-blue-500 text-white' : 'border border-gray-300 hover:bg-gray-50'} text-sm">${p}</button>`;
            }).join('');
        }

        function changeLogsPage(direction) {
            if (direction === 'prev' && logsCurrentPage > 1) {
                logsCurrentPage--;
                renderLogsPage();
            } else if (direction === 'next') {
                const totalPages = Math.ceil(allLogs.length / logsPageSize);
                if (logsCurrentPage < totalPages) {
                    logsCurrentPage++;
                    renderLogsPage();
                }
            }
        }

        function goToLogsPage(page) {
            logsCurrentPage = page;
            renderLogsPage();
        }

        async function loadStrategy() {
            try { const data = await fetchApi('/api/strategy'); document.getElementById('strategy').value = data.strategy; }
            catch (e) { console.error(e); }
        }

        async function setStrategy(value) {
            try { await fetchApi('/api/strategy', { method: 'POST', body: JSON.stringify({ strategy: value }) }); showToast('Á≠ñÁï•Â∑≤Êõ¥Êñ∞', 'success'); }
            catch (e) { showToast('ËÆæÁΩÆÂ§±Ë¥•: ' + e.message, 'error'); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(t => { t.classList.remove('border-blue-500', 'text-blue-600'); t.classList.add('border-transparent', 'text-gray-500'); });
            document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('border-blue-500', 'text-blue-600');
            document.querySelectorAll('.tab-content').forEach((c) => {
                c.classList.add('hidden');
            });
            document.getElementById('tab-' + tab).classList.remove('hidden');
            if (tab === 'users') loadUsers();
            if (tab === 'accounts') loadAccounts();
            if (tab === 'agt-accounts') loadAgtAccounts();
            if (tab === 'logs') {
                loadLogs();
                const toggle = document.getElementById('autoRefreshToggle');
                if (toggle && toggle.checked && !autoRefreshInterval) {
                    autoRefreshInterval = setInterval(() => { loadLogs(); }, 5000);
                }
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
            if (tab === 'settings') { document.getElementById('baseUrl').textContent = location.origin; }
        }

        async function loadUsers() {
            try {
                const data = await fetchApi('/api/admin/users');
                allUsers = data.data || [];
                renderUsersPage();
            } catch (e) {
                console.error(e);
                showToast('Âä†ËΩΩÁî®Êà∑ÂàóË°®Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        function renderUsersPage() {
            const container = document.getElementById('users-table');

            if (allUsers.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">ÊöÇÊó†Áî®Êà∑</div>';
                document.getElementById('users-pagination').classList.add('hidden');
                return;
            }

            document.getElementById('users-pagination').classList.remove('hidden');

            // ÂàÜÈ°µËÆ°ÁÆó
            const totalPages = Math.ceil(allUsers.length / usersPageSize);
            const startIdx = (usersCurrentPage - 1) * usersPageSize;
            const endIdx = Math.min(startIdx + usersPageSize, allUsers.length);
            const pageUsers = allUsers.slice(startIdx, endIdx);

            // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
            document.getElementById('users-page-start').textContent = startIdx + 1;
            document.getElementById('users-page-end').textContent = endIdx;
            document.getElementById('total-users').textContent = allUsers.length;
            document.getElementById('users-prev-btn').disabled = usersCurrentPage === 1;
            document.getElementById('users-next-btn').disabled = usersCurrentPage === totalPages;

            // Ê∏≤ÊüìÈ°µÁ†Å
            renderUsersPageNumbers(totalPages);

            // Ê∏≤ÊüìË°®Ê†º
            container.innerHTML = `
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <th class="px-4 py-3 rounded-tl-lg">Áî®Êà∑Âêç</th>
                            <th class="px-4 py-3">API Key</th>
                            <th class="px-4 py-3">‰ΩôÈ¢ù</th>
                            <th class="px-4 py-3">ËØ∑Ê±ÇÊï∞</th>
                            <th class="px-4 py-3">ÊÄªÊ∂àË¥π</th>
                            <th class="px-4 py-3">Áä∂ÊÄÅ</th>
                            <th class="px-4 py-3 rounded-tr-lg">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${pageUsers.map((u, i) => `
                            <tr class="hover:bg-gray-50 transition ${i % 2 === 1 ? 'bg-gray-50/50' : ''}">
                                <td class="px-4 py-4">
                                    <div class="font-medium text-gray-900">${u.username}</div>
                                    <div class="text-xs text-gray-500">${u.role === 'admin' ? 'ÁÆ°ÁêÜÂëò' : 'ÊôÆÈÄöÁî®Êà∑'}</div>
                                    <div class="mt-1 flex items-center gap-1.5 flex-wrap">${formatUserChannelBadges(u.allowed_channels)}</div>
                                    ${u.subscription_type && u.subscription_type !== 'none'
                    ? `<div class="mt-1"><span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">${u.subscription_type === 'daily' ? 'ÊØèÊó•Â•óÈ§ê' : 'ÊØèÊúàÂ•óÈ§ê'}</span></div>`
                    : ''}
                                </td>
                                <td class="px-4 py-4">
                                    <div class="flex items-center gap-2">
                                        <code class="text-xs bg-gray-100 px-2 py-1 rounded font-mono select-all">${u.api_key}</code>
                                        <button onclick="copyText(\`${u.api_key}\`)" class="text-blue-500 hover:text-blue-700 text-xs" title="Â§çÂà∂API Key">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                                <td class="px-4 py-4">
                                    <span class="font-medium ${u.balance > 0 ? 'text-green-600' : 'text-red-600'}">$${u.balance.toFixed(4)}</span>
                                </td>
                                <td class="px-4 py-4 text-gray-600">${u.total_requests || 0}</td>
                                <td class="px-4 py-4 text-gray-900">$${(u.total_cost || 0).toFixed(4)}</td>
                                <td class="px-4 py-4">
                                    ${u.status === 'active'
                    ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">Ê¥ªË∑É</span>'
                    : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium">ÂÅúÁî®</span>'}
                                </td>
                                <td class="px-4 py-4">
                                    <div class="flex items-center gap-2">
                                        <button onclick="showSubscriptionModal('${u.id}', '${u.username}')" class="p-1.5 text-purple-600 hover:bg-purple-50 rounded transition" title="ËÆ¢ÈòÖÁÆ°ÁêÜ">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </button>
                                        <button onclick="showRechargeModal('${u.id}', '${u.username}', ${u.balance})" class="p-1.5 text-green-600 hover:bg-green-50 rounded transition" title="‰øÆÊîπÈ¢ùÂ∫¶">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            </svg>
                                        </button>
                                        <button onclick="showPermissionModal('${u.id}', '${u.username.replace(/'/g, "\\'")}')" class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded transition" title="ÊùÉÈôêÁÆ°ÁêÜ">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422A12.083 12.083 0 0112 20.055a12.083 12.083 0 01-6.16-9.477L12 14z"/>
                                            </svg>
                                        </button>
                                        <button onclick="refreshUserStats('${u.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded transition" title="Âà∑Êñ∞ÁªüËÆ°">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                        </button>
                                        ${u.status === 'active'
                    ? `<button onclick="toggleUserStatus('${u.id}', 'suspended')" class="p-1.5 text-orange-600 hover:bg-orange-50 rounded transition" title="Á¶ÅÁî®">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                                </svg>
                                            </button>`
                    : `<button onclick="toggleUserStatus('${u.id}', 'active')" class="p-1.5 text-green-600 hover:bg-green-50 rounded transition" title="ÂêØÁî®">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </button>`
                }
                                        <button onclick="deleteUser('${u.id}')" class="p-1.5 text-red-600 hover:bg-red-50 rounded transition" title="Âà†Èô§">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderUsersPageNumbers(totalPages) {
            const container = document.getElementById('users-page-numbers');
            const maxVisible = 5;
            let pages = [];

            if (totalPages <= maxVisible) {
                pages = Array.from({ length: totalPages }, (_, i) => i + 1);
            } else {
                if (usersCurrentPage <= 3) {
                    pages = [1, 2, 3, 4, '...', totalPages];
                } else if (usersCurrentPage >= totalPages - 2) {
                    pages = [1, '...', totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
                } else {
                    pages = [1, '...', usersCurrentPage - 1, usersCurrentPage, usersCurrentPage + 1, '...', totalPages];
                }
            }

            container.innerHTML = pages.map(p => {
                if (p === '...') {
                    return '<span class="px-3 py-1 text-gray-400">...</span>';
                }
                const isActive = p === usersCurrentPage;
                return `<button onclick="goToUsersPage(${p})" class="px-3 py-1 rounded ${isActive ? 'bg-blue-500 text-white' : 'border border-gray-300 hover:bg-gray-50'} text-sm">${p}</button>`;
            }).join('');
        }

        function changeUsersPage(direction) {
            if (direction === 'prev' && usersCurrentPage > 1) {
                usersCurrentPage--;
                renderUsersPage();
            } else if (direction === 'next') {
                const totalPages = Math.ceil(allUsers.length / usersPageSize);
                if (usersCurrentPage < totalPages) {
                    usersCurrentPage++;
                    renderUsersPage();
                }
            }
        }

        function goToUsersPage(page) {
            usersCurrentPage = page;
            renderUsersPage();
        }

        function updateUsernamePreview() {
            const username = document.getElementById('new-username').value.trim();
            const count = parseInt(document.getElementById('new-count').value) || 1;
            const preview = document.getElementById('username-preview');

            if (username && count === 1) {
                preview.textContent = username;
            } else if (count === 1) {
                const randomStr = Math.random().toString(36).substring(2, 8);
                preview.textContent = `user_${randomStr}`;
            } else {
                const randomStr = Math.random().toString(36).substring(2, 8);
                preview.textContent = `user_${randomStr}, user_${Math.random().toString(36).substring(2, 8)}, ... (ÂÖ±${count}‰∏™)`;
            }
        }

        function setSubQuota(amount) {
            document.getElementById('new-subscription-quota').value = amount;

            // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊåâÈíÆ
            document.querySelectorAll('.sub-quota-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-50', 'text-purple-600');
                btn.classList.add('border-gray-200');
            });
            event.target.classList.remove('border-gray-200');
            event.target.classList.add('border-purple-500', 'bg-purple-50', 'text-purple-600');
        }

        function setSubDuration(months) {
            document.getElementById('new-subscription-duration').value = months;

            // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊåâÈíÆ
            document.querySelectorAll('.sub-duration-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-50', 'text-purple-600');
                btn.classList.add('border-gray-200');
            });
            event.target.classList.remove('border-gray-200');
            event.target.classList.add('border-purple-500', 'bg-purple-50', 'text-purple-600');
        }

        function toggleSubscriptionOptions() {
            const checkbox = document.getElementById('new-with-subscription');
            const options = document.getElementById('subscription-options');
            if (checkbox.checked) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        async function createUser() {
            let username = document.getElementById('new-username').value.trim();
            const count = parseInt(document.getElementById('new-count').value) || 1;
            const balance = parseFloat(document.getElementById('new-balance').value) || 0;
            const withSubscription = document.getElementById('new-with-subscription').checked;

            // Ëé∑ÂèñËÆ¢ÈòÖÈÖçÁΩÆ
            let subType, subQuota, subDuration;
            if (withSubscription) {
                subType = document.querySelector('input[name="sub-type"]:checked').value;
                subQuota = parseFloat(document.getElementById('new-subscription-quota').value);
                subDuration = parseInt(document.getElementById('new-subscription-duration').value);

                if (!subQuota || subQuota <= 0) {
                    showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂÖÖÂÄºÈ¢ùÂ∫¶', 'warning');
                    return;
                }
                if (!subDuration || subDuration <= 0) {
                    showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂºÄÈÄöÊó∂Èïø', 'warning');
                    return;
                }
            }

            try {
                const createdUsers = [];
                const failedUsers = [];

                // ÊòæÁ§∫ËøõÂ∫¶ÊèêÁ§∫
                if (count > 1) {
                    showToast(`ÂºÄÂßãÂàõÂª∫ ${count} ‰∏™Áî®Êà∑...`, 'info');
                }

                for (let i = 0; i < count; i++) {
                    try {
                        // ÁîüÊàêÂîØ‰∏ÄÁî®Êà∑Âêç
                        let finalUsername = username;
                        if (!finalUsername || count > 1) {
                            // ‰ΩøÁî®Êó∂Èó¥Êà≥+ÈöèÊú∫Êï∞Á°Æ‰øùÂîØ‰∏ÄÊÄß
                            const timestamp = Date.now().toString(36);
                            const randomStr = Math.random().toString(36).substring(2, 6);
                            finalUsername = `user_${timestamp}${randomStr}`;
                        }

                        // ÂàõÂª∫Áî®Êà∑
                        const userResult = await fetchApi('/api/admin/users', {
                            method: 'POST',
                            body: JSON.stringify({
                                username: finalUsername,
                                balance
                            })
                        });

                        createdUsers.push(finalUsername);

                        // Â¶ÇÊûúÈúÄË¶ÅÂºÄÈÄöËÆ¢ÈòÖ
                        if (withSubscription && userResult.data && userResult.data.id) {
                            await fetchApi(`/api/admin/users/${userResult.data.id}/subscription`, {
                                method: 'POST',
                                body: JSON.stringify({
                                    type: subType,
                                    quota: subQuota,
                                    duration: subDuration
                                })
                            });
                        }
                    } catch (e) {
                        console.error(`ÂàõÂª∫Áî®Êà∑Â§±Ë¥• (${i + 1}/${count}):`, e);
                        failedUsers.push(i + 1);
                    }
                }

                hideModal('createUserModal');
                document.getElementById('new-username').value = '';
                document.getElementById('new-count').value = '1';
                document.getElementById('new-balance').value = '0';
                document.getElementById('new-with-subscription').checked = false;
                document.getElementById('new-subscription-quota').value = '1800';
                document.getElementById('new-subscription-duration').value = '12';
                toggleSubscriptionOptions();
                updateUsernamePreview();
                loadUsers();

                // ÊòæÁ§∫ÁªìÊûú
                if (failedUsers.length === 0) {
                    if (count === 1) {
                        showToast(`Áî®Êà∑ ${createdUsers[0]} ÂàõÂª∫ÊàêÂäü${withSubscription ? 'ÔºåËÆ¢ÈòÖÂ∑≤ÂºÄÈÄö' : ''}`, 'success');
                    } else {
                        showToast(`ÊàêÂäüÂàõÂª∫ ${count} ‰∏™Áî®Êà∑${withSubscription ? 'ÔºåËÆ¢ÈòÖÂ∑≤ÂºÄÈÄö' : ''}`, 'success');
                    }
                } else {
                    showToast(`ÂàõÂª∫ÂÆåÊàêÔºöÊàêÂäü ${createdUsers.length} ‰∏™ÔºåÂ§±Ë¥• ${failedUsers.length} ‰∏™`, 'warning');
                }
            } catch (e) {
                showToast('ÂàõÂª∫Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        function showRechargeModal(userId, username, balance) {
            currentRechargeUserId = userId;
            document.getElementById('recharge-username').textContent = username;
            document.getElementById('recharge-balance').textContent = '$' + balance.toFixed(4);
            document.getElementById('recharge-amount').value = '';
            document.getElementById('recharge-notes').value = '';
            showModal('rechargeModal');
        }

        async function doRecharge() {
            const amount = parseFloat(document.getElementById('recharge-amount').value);
            const notes = document.getElementById('recharge-notes').value.trim();

            if (!Number.isFinite(amount) || amount === 0) {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË∞ÉÊï¥ÈáëÈ¢ùÔºà‰∏çËÉΩ‰∏∫ 0Ôºâ', 'warning');
                return;
            }

            try {
                await fetchApi(`/api/admin/users/${currentRechargeUserId}/recharge`, {
                    method: 'POST',
                    body: JSON.stringify({ amount, notes })
                });
                hideModal('rechargeModal');
                loadUsers();
                showToast(amount > 0 ? 'È¢ùÂ∫¶Â¢ûÂä†ÊàêÂäü' : 'È¢ùÂ∫¶Êâ£ÂáèÊàêÂäü', 'success');
            } catch (e) {
                showToast('È¢ùÂ∫¶Ë∞ÉÊï¥Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Áî®Êà∑ÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) return;
            try {
                await fetchApi(`/api/admin/users/${userId}`, { method: 'DELETE' });
                loadUsers();
                showToast('Áî®Êà∑Â∑≤Âà†Èô§', 'error');
            } catch (e) {
                showToast('Âà†Èô§Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function refreshUserStats(userId) {
            try {
                showToast('Ê≠£Âú®Âà∑Êñ∞ÁªüËÆ°...', 'info');
                await fetchApi(`/api/admin/users/${userId}`);
                loadUsers();
                showToast('ÁªüËÆ°Â∑≤Âà∑Êñ∞', 'success');
            } catch (e) {
                showToast('Âà∑Êñ∞Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            const action = newStatus === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
            if (newStatus === 'suspended' && !confirm(`Á°ÆÂÆöÁ¶ÅÁî®Ê≠§Áî®Êà∑Ôºü`)) return;
            try {
                await fetchApi(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });
                loadUsers();
                showToast(`Áî®Êà∑Â∑≤${action}`, newStatus === 'active' ? 'success' : 'warning');
            } catch (e) {
                showToast(`${action}Â§±Ë¥•: ` + e.message, 'error');
            }
        }

        function showModal(id) {
            if (id === 'importModal') resetImportResultView(false);
            document.getElementById(id).classList.remove('hidden');
        }

        function hideModal(id) {
            document.getElementById(id).classList.add('hidden');
            if (id === 'importModal') resetImportResultView(true);
        }
        function toggleIdcFields() { document.getElementById('idc-fields').classList.toggle('hidden', document.getElementById('acc-auth').value !== 'idc'); }

        async function addAccount() {
            const data = { name: document.getElementById('acc-name').value || 'Êú™ÂëΩÂêçË¥¶Âè∑', auth_method: document.getElementById('acc-auth').value, refresh_token: document.getElementById('acc-refresh').value, client_id: document.getElementById('acc-client-id').value || null, client_secret: document.getElementById('acc-client-secret').value || null };
            if (!data.refresh_token) { showToast('ËØ∑Â°´ÂÜô Refresh Token', 'warning'); return; }
            try { await fetchApi('/api/accounts', { method: 'POST', body: JSON.stringify(data) }); hideModal('addModal'); refresh(); showToast('Ê∑ªÂä†ÊàêÂäü', 'success'); }
            catch (e) { showToast('Ê∑ªÂä†Â§±Ë¥•: ' + e.message, 'error'); }
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderImportTypeBadge(type) {
            if (type === 'IdC/BuilderId/Enterprise') {
                return '<span class="px-2.5 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700">IdC/BuilderId/Enterprise</span>';
            }
            return '<span class="px-2.5 py-1 rounded-full text-xs font-medium bg-sky-100 text-sky-700">Social</span>';
        }

        function resetImportResultView(clearInput) {
            const inputSection = document.getElementById('import-input-section');
            const resultSection = document.getElementById('import-result-section');
            const submitBtn = document.getElementById('import-submit-btn');
            const resetBtn = document.getElementById('import-reset-btn');
            const failedBlock = document.getElementById('import-failed-block');

            if (inputSection) inputSection.classList.remove('hidden');
            if (resultSection) resultSection.classList.add('hidden');
            if (failedBlock) failedBlock.classList.add('hidden');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>ÂºÄÂßãÂØºÂÖ•';
            }
            if (resetBtn) resetBtn.classList.add('hidden');

            if (clearInput) {
                const input = document.getElementById('import-json');
                const fileName = document.getElementById('file-name');
                if (input) input.value = '';
                if (fileName) fileName.textContent = '';
            }
        }

        function renderImportResult(result) {
            const rows = Array.isArray(result.results) ? result.results : [];
            const successRows = rows.filter(item => item.success);
            const failedRows = rows.filter(item => !item.success);

            const idcCount = successRows.filter(item => item.type === 'IdC/BuilderId/Enterprise').length;
            const socialCount = successRows.filter(item => item.type === 'Social').length;

            document.getElementById('import-total-count').textContent = result.total || rows.length;
            document.getElementById('import-success-count').textContent = result.success || successRows.length;
            document.getElementById('import-failed-count').textContent = result.failed || failedRows.length;
            document.getElementById('import-idc-count').textContent = idcCount;
            document.getElementById('import-social-count').textContent = socialCount;

            const statusBadge = document.getElementById('import-result-status');
            if ((result.failed || failedRows.length) > 0) {
                statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-700';
                statusBadge.textContent = 'ÈÉ®ÂàÜÂ§±Ë¥•';
            } else {
                statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
                statusBadge.textContent = 'ÂÖ®ÈÉ®ÊàêÂäü';
            }

            const successList = document.getElementById('import-success-list');
            if (successRows.length === 0) {
                successList.innerHTML = '<div class="text-sm text-gray-500">Ê≤°ÊúâÊàêÂäüÂØºÂÖ•ÁöÑË¥¶Âè∑</div>';
            } else {
                successList.innerHTML = successRows.map(item => {
                    const name = escapeHtml(item.name || 'Êú™ÂëΩÂêçË¥¶Âè∑');
                    const type = item.type === 'IdC/BuilderId/Enterprise' ? 'IdC/BuilderId/Enterprise' : 'Social';
                    return `<div class="flex items-center justify-between gap-3 border border-gray-100 rounded-lg px-3 py-2"><span class="text-gray-800 break-all">${name}</span>${renderImportTypeBadge(type)}</div>`;
                }).join('');
            }

            const failedBlock = document.getElementById('import-failed-block');
            const failedList = document.getElementById('import-failed-list');
            if (failedRows.length > 0) {
                failedBlock.classList.remove('hidden');
                failedList.innerHTML = failedRows.map(item => {
                    const name = escapeHtml(item.name || 'Êú™ÂëΩÂêçË¥¶Âè∑');
                    const error = escapeHtml(item.error || 'Êú™Áü•ÈîôËØØ');
                    return `<div class="bg-white border border-red-100 rounded-lg px-3 py-2"><div class="font-medium text-red-700 break-all">${name}</div><div class="text-xs text-red-500 mt-1 break-all">${error}</div></div>`;
                }).join('');
            } else {
                failedBlock.classList.add('hidden');
                failedList.innerHTML = '';
            }

            document.getElementById('import-input-section').classList.add('hidden');
            document.getElementById('import-result-section').classList.remove('hidden');
            document.getElementById('import-reset-btn').classList.remove('hidden');
        }

        async function importAccounts() {
            let jsonContent = document.getElementById('import-json').value.trim();
            if (!jsonContent) { showToast('ËØ∑ÈÄâÊã©Êñá‰ª∂ÊàñÁ≤òË¥¥ JSON ÂÜÖÂÆπ', 'warning'); return; }
            try { JSON.parse(jsonContent); } catch { showToast('JSON Ê†ºÂºèÈîôËØØ', 'error'); return; }

            const submitBtn = document.getElementById('import-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>ÂØºÂÖ•‰∏≠...';

            try {
                const result = await fetchApi('/api/admin/accounts/import', { method: 'POST', body: JSON.stringify({ raw_json: jsonContent }) });
                await loadAccounts();
                await loadStatus();
                renderImportResult(result);
                showToast(`ÂØºÂÖ•ÂÆåÊàêÔºÅÊàêÂäü: ${result.success} ‰∏™ÔºåÂ§±Ë¥•: ${result.failed} ‰∏™`, result.failed > 0 ? 'warning' : 'success');
            } catch (e) { showToast('ÂØºÂÖ•Â§±Ë¥•: ' + e.message, 'error'); }
            finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>ÂºÄÂßãÂØºÂÖ•';
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('file-name').textContent = `Â∑≤ÈÄâÊã©: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => { document.getElementById('import-json').value = e.target.result; };
            reader.readAsText(file);
        }

        function loadTemplate(type) {
            let template;
            if (type === 'social') {
                template = JSON.stringify([{
                    name: "GoogleË¥¶Âè∑Á§∫‰æã",
                    refreshToken: "aor_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
                    authMethod: "social",
                    provider: "Google"
                }], null, 2);
            } else if (type === 'builderid') {
                template = JSON.stringify([{
                    name: "BuilderIdË¥¶Âè∑Á§∫‰æã",
                    refreshToken: "aor_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
                    authMethod: "idc",
                    clientId: "your-client-id",
                    clientSecret: "your-client-secret",
                    region: "us-east-1",
                    provider: "BuilderId"
                }], null, 2);
            } else if (type === 'enterprise') {
                template = JSON.stringify([{
                    name: "EnterpriseË¥¶Âè∑Á§∫‰æã",
                    refreshToken: "aor_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
                    authMethod: "idc",
                    clientId: "your-client-id",
                    clientSecret: "your-client-secret",
                    region: "us-east-1",
                    provider: "Enterprise"
                }], null, 2);
            }
            document.getElementById('import-json').value = template;
            showToast('Ê®°ÊùøÂ∑≤Âä†ËΩΩÔºåËØ∑ÊõøÊç¢Á§∫‰æãÊï∞ÊçÆ', 'info');
        }

        async function removeAccount(id, dependencyCount = 0) {
            let force = false;
            if (dependencyCount > 0) {
                const confirmed = confirm(`ËØ•Ë¥¶Âè∑Â≠òÂú® ${dependencyCount} Êù°ËØ∑Ê±ÇÊó•Âøó„ÄÇ\n\nÂº∫Âà∂Âà†Èô§Â∞ÜÂêåÊó∂Âà†Èô§Ëøô‰∫õÊó•ÂøóÔºå‰∏î‰∏çÂèØÊÅ¢Â§ç„ÄÇ\n\nÁ°ÆËÆ§Âº∫Âà∂Âà†Èô§Ôºü`);
                if (!confirmed) return;
                force = true;
            } else {
                if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Ë¥¶Âè∑Ôºü')) return;
            }

            try {
                const url = force ? `/api/admin/accounts/${id}?force=true` : `/api/admin/accounts/${id}`;
                const result = await fetchApi(url, { method: 'DELETE' });
                refresh();
                if (force) {
                    const deletedLogs = result?.data?.deletedLogs ?? dependencyCount;
                    showToast(`Ë¥¶Âè∑Â∑≤Âº∫Âà∂Âà†Èô§ÔºåÂπ∂Ê∏ÖÁêÜ ${deletedLogs} Êù°ËØ∑Ê±ÇÊó•Âøó`, 'warning');
                } else {
                    showToast('Ë¥¶Âè∑Â∑≤Âà†Èô§', 'success');
                }
            }
            catch (e) {
                if (e.status === 409) {
                    const depCount = e.payload?.error?.dependencyCount;
                    if (depCount !== undefined) {
                        showToast(`Êó†Ê≥ïÂà†Èô§ÔºöÂ≠òÂú® ${depCount} Êù°ËØ∑Ê±ÇÊó•ÂøóÔºåËØ∑ÊîπÁî®‚ÄúÁ¶ÅÁî®‚Äù`, 'warning');
                    } else {
                        showToast('Êó†Ê≥ïÂà†Èô§ÔºöË¥¶Âè∑Â≠òÂú®ÂÖ≥ËÅîÊï∞ÊçÆÔºåËØ∑ÊîπÁî®‚ÄúÁ¶ÅÁî®‚Äù', 'warning');
                    }
                    return;
                }
                showToast('Âà†Èô§Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function enableAccount(id, buttonEl = null) {
            const originalHtml = buttonEl ? buttonEl.innerHTML : '';
            try {
                if (buttonEl) {
                    buttonEl.disabled = true;
                    buttonEl.classList.add('opacity-60', 'cursor-wait');
                    buttonEl.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"></path></svg>';
                }
                await fetchApi(`/api/admin/accounts/${id}/enable`, { method: 'POST' });
                const target = allAccounts.find(a => a.id === id);
                if (target) {
                    target.status = 'active';
                    renderAccountsPage();
                }
                loadStatus();
                showToast('Ë¥¶Âè∑Â∑≤ÂêØÁî®', 'success');
            }
            catch (e) { showToast('ÂêØÁî®Â§±Ë¥•: ' + e.message, 'error'); }
            finally {
                if (buttonEl) {
                    buttonEl.disabled = false;
                    buttonEl.classList.remove('opacity-60', 'cursor-wait');
                    buttonEl.innerHTML = originalHtml;
                }
            }
        }

        async function disableAccount(id, buttonEl = null) {
            if (!confirm('Á°ÆÂÆöÁ¶ÅÁî®Ê≠§Ë¥¶Âè∑Ôºü')) return;
            const originalHtml = buttonEl ? buttonEl.innerHTML : '';
            try {
                if (buttonEl) {
                    buttonEl.disabled = true;
                    buttonEl.classList.add('opacity-60', 'cursor-wait');
                    buttonEl.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v3a5 5 0 00-5 5H4z"></path></svg>';
                }
                await fetchApi(`/api/admin/accounts/${id}/disable`, { method: 'POST' });
                const target = allAccounts.find(a => a.id === id);
                if (target) {
                    target.status = 'disabled';
                    renderAccountsPage();
                }
                loadStatus();
                showToast('Ë¥¶Âè∑Â∑≤Á¶ÅÁî®', 'warning');
            }
            catch (e) { showToast('Á¶ÅÁî®Â§±Ë¥•: ' + e.message, 'error'); }
            finally {
                if (buttonEl) {
                    buttonEl.disabled = false;
                    buttonEl.classList.remove('opacity-60', 'cursor-wait');
                    buttonEl.innerHTML = originalHtml;
                }
            }
        }

        function exportAccountJson(id) {
            const account = allAccounts.find(a => a.id === id);
            if (!account) {
                showToast('Ë¥¶Âè∑‰∏çÂ≠òÂú®', 'error');
                return;
            }

            // ÊûÑÂª∫ÂØºÂá∫ÁöÑ JSON ÂØπË±°Ôºà‰∏éÂØºÂÖ•Ê†ºÂºè‰∏ÄËá¥Ôºâ
            const exportData = {
                name: account.name,
                refreshToken: account.refresh_token,
                authMethod: account.auth_method
            };

            // Â¶ÇÊûúÊòØ IdC Ë¥¶Âè∑ÔºåÊ∑ªÂä†È¢ùÂ§ñÂ≠óÊÆµ
            if (account.auth_method === 'idc') {
                exportData.clientId = account.client_id;
                exportData.clientSecret = account.client_secret;
                exportData.region = account.region || 'us-east-1';
            }

            // Ê∑ªÂä† provider Â≠óÊÆµÔºàÂøÖÈúÄÔºâ
            // Ê†πÊçÆ authMethod Êé®Êñ≠ provider
            if (account.auth_method === 'social') {
                // Social Ë¥¶Âè∑ÈªòËÆ§‰∏∫ GoogleÔºåÂèØ‰ª•Ê†πÊçÆ user_email Âà§Êñ≠
                exportData.provider = 'Google';
            } else {
                // IdC Ë¥¶Âè∑ÈªòËÆ§‰∏∫ BuilderId
                exportData.provider = 'BuilderId';
            }

            // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
            const jsonStr = JSON.stringify(exportData, null, 2);
            navigator.clipboard.writeText(jsonStr).then(() => {
                showToast('Ë¥¶Âè∑ JSON Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            }).catch(() => {
                showToast('Â§çÂà∂Â§±Ë¥•', 'error');
            });
        }

        async function changeAdminKey() {
            const newKey = document.getElementById('new-admin-key').value.trim();
            if (!newKey) { showToast('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁÆ°ÁêÜÂØÜÈí•', 'warning'); return; }
            if (newKey.length < 6) { showToast('ÂØÜÈí•ÈïøÂ∫¶Ëá≥Â∞ë 6 ‰Ωç', 'warning'); return; }
            if (!confirm('Á°ÆÂÆö‰øÆÊîπÁÆ°ÁêÜÂØÜÈí•Ôºü‰øÆÊîπÂêéÈúÄË¶ÅÈáçÊñ∞ÁôªÂΩï„ÄÇ')) return;
            try {
                await fetchApi('/api/admin/settings/admin-key', {
                    method: 'PUT',
                    body: JSON.stringify({ newKey: newKey })
                });
                showToast('‰øÆÊîπÊàêÂäüÔºÅËØ∑ÈáçÊñ∞ÁôªÂΩï', 'success');
                setTimeout(() => logout(), 1500);
            }
            catch (e) { showToast('‰øÆÊîπÂ§±Ë¥•: ' + e.message, 'error'); }
        }

        async function loadApiKeys() {
            try {
                const keys = await fetchApi('/api/settings/api-keys');
                const container = document.getElementById('api-keys-list');
                if (!keys || keys.length === 0) { container.innerHTML = '<div class="text-gray-500">ÊöÇÊó† API ÂØÜÈí•</div>'; return; }
                container.innerHTML = `<table class="w-full"><thead><tr class="bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><th class="px-4 py-3 rounded-tl-lg">ÂØÜÈí•</th><th class="px-4 py-3 rounded-tr-lg">Êìç‰Ωú</th></tr></thead><tbody class="divide-y divide-gray-100">${keys.map(k => `<tr class="hover:bg-gray-50 transition"><td class="px-4 py-3 font-mono text-sm text-gray-900">${k.key}</td><td class="px-4 py-3"><button onclick="copyText('${k.key}')" class="text-blue-500 hover:text-blue-700 text-sm font-medium mr-3">Â§çÂà∂</button><button onclick="removeApiKey('${k.key}')" class="text-red-500 hover:text-red-700 text-sm font-medium">Âà†Èô§</button></td></tr>`).join('')}</tbody></table>`;
            } catch (e) { console.error(e); }
        }

        async function addApiKey() {
            const newKey = document.getElementById('new-api-key').value.trim();
            if (!newKey) { showToast('ËØ∑ËæìÂÖ• API ÂØÜÈí•', 'warning'); return; }
            if (newKey.length < 6) { showToast('ÂØÜÈí•ÈïøÂ∫¶Ëá≥Â∞ë 6 ‰Ωç', 'warning'); return; }
            try { await fetchApi('/api/settings/api-keys', { method: 'POST', body: JSON.stringify({ key: newKey }) }); document.getElementById('new-api-key').value = ''; loadApiKeys(); showToast('Ê∑ªÂä†ÊàêÂäü', 'success'); }
            catch (e) { showToast('Ê∑ªÂä†Â§±Ë¥•: ' + e.message, 'error'); }
        }

        async function removeApiKey(key) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§ API ÂØÜÈí•Ôºü')) return;
            try { await fetchApi('/api/settings/api-keys', { method: 'DELETE', body: JSON.stringify({ key }) }); loadApiKeys(); showToast('Âà†Èô§ÊàêÂäü', 'success'); }
            catch (e) { showToast('Âà†Èô§Â§±Ë¥•: ' + e.message, 'error'); }
        }

        function copyText(text) {
            // Check if Clipboard API is available (requires HTTPS)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                // Fallback for HTTP or older browsers
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            } catch (err) {
                showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
            }
            document.body.removeChild(textarea);
        }

        // ==================== Subscription Management ====================

        let currentSubscriptionUserId = null;
        let currentPermissionUserId = null;

        function normalizeModelListText(value) {
            return String(value || '')
                .split('\n')
                .map((line) => line.trim())
                .filter(Boolean);
        }

        const ALL_MODELS = {
            kiro: [
                { id: 'claude-sonnet-4-5-20250929', name: 'Claude Sonnet 4.5' },
                { id: 'claude-opus-4-5-20251101', name: 'Claude Opus 4.5' },
                { id: 'claude-haiku-4-5-20251001', name: 'Claude Haiku 4.5' },
                { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet' },
                { id: 'claude-3-5-haiku-20241022', name: 'Claude 3.5 Haiku' }
            ],
            agt: [
                { id: 'antigravity-gemini-3-pro', name: 'Gemini 3 Pro' },
                { id: 'antigravity-gemini-3-flash', name: 'Gemini 3 Flash' },
                { id: 'antigravity-gemini-2-5-flash', name: 'Gemini 2.5 Flash' },
                { id: 'antigravity-claude-sonnet-4-5', name: 'Claude Sonnet 4.5' },
                { id: 'antigravity-claude-sonnet-4-5-thinking', name: 'Claude Sonnet 4.5 (Thinking)' },
                { id: 'antigravity-claude-opus-4-5-thinking', name: 'Claude Opus 4.5 (Thinking)' },
                { id: 'antigravity-claude-opus-4-6-thinking', name: 'Claude Opus 4.6 (Thinking)' }
            ]
        };

        async function showPermissionModal(userId, username) {
            currentPermissionUserId = userId;
            document.getElementById('permission-username').textContent = `Áî®Êà∑Ôºö${username}`;

            // ÈáçÁΩÆÂ§çÈÄâÊ°Ü
            document.querySelectorAll('.channel-checkbox').forEach(cb => cb.checked = false);

            try {
                const response = await fetchApi(`/api/admin/users/${userId}`);
                const user = response?.data || {};
                const channels = Array.isArray(user.allowed_channels) && user.allowed_channels.length > 0
                    ? user.allowed_channels
                    : ['kiro'];

                // ÂãæÈÄâÁî®Êà∑Êã•ÊúâÁöÑÊ∏†ÈÅì
                channels.forEach(ch => {
                    const cb = document.getElementById(`perm-channel-${ch}`);
                    if (cb) cb.checked = true;
                });

                // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïÊ∏†ÈÅìË¢´ÂãæÈÄâÔºàÂºÇÂ∏∏ÊÉÖÂÜµÔºâÔºåÈªòËÆ§ÂãæÈÄâ Kiro
                if (document.querySelectorAll('.channel-checkbox:checked').length === 0) {
                    const kiroCb = document.getElementById('perm-channel-kiro');
                    if (kiroCb) kiroCb.checked = true;
                }

                window.currentUserModels = Array.isArray(user.allowed_models) ? user.allowed_models : [];
                updateModelCheckboxes();

                // ÁªëÂÆö‰∫ã‰ª∂
                document.querySelectorAll('.channel-checkbox').forEach(cb => {
                    cb.removeEventListener('change', updateModelCheckboxes); // Èò≤Ê≠¢ÈáçÂ§çÁªëÂÆö
                    cb.addEventListener('change', updateModelCheckboxes);
                });
            } catch (e) {
                showToast('Âä†ËΩΩÊùÉÈôêÂ§±Ë¥•: ' + e.message, 'error');
            }

            showModal('permissionModal');
        }

        function updateModelCheckboxes() {
            const container = document.getElementById('perm-models-container');
            container.innerHTML = '';

            const selectedChannels = Array.from(document.querySelectorAll('.channel-checkbox:checked')).map(cb => cb.value);
            const userModels = window.currentUserModels || [];

            if (selectedChannels.length === 0) {
                container.innerHTML = '<div class="text-sm text-gray-500 text-center py-8">ËØ∑ÂÖàÂãæÈÄâ‰∏äÊñπÊ∏†ÈÅì</div>';
                return;
            }

            selectedChannels.forEach(channel => {
                const models = ALL_MODELS[channel] || [];
                if (models.length === 0) return;

                const section = document.createElement('div');
                section.className = 'bg-white rounded-lg border border-gray-100 overflow-hidden';

                const channelName = channel === 'kiro' ? 'Kiro' : 'AGT';
                const channelColor = channel === 'kiro' ? 'text-blue-600 bg-blue-50' : 'text-indigo-600 bg-indigo-50';
                const borderColor = channel === 'kiro' ? 'border-blue-100' : 'border-indigo-100';

                // Header
                const header = document.createElement('div');
                header.className = `px-3 py-2 ${channelColor} border-b ${borderColor} flex justify-between items-center`;
                header.innerHTML = `
                    <span class="font-semibold text-sm">${channelName} Ê®°Âûã</span>
                    <div class="flex gap-2">
                        <button type="button" onclick="batchSelectModels('${channel}', true)" class="text-xs hover:underline opacity-80 hover:opacity-100">ÂÖ®ÈÄâ</button>
                        <button type="button" onclick="batchSelectModels('${channel}', false)" class="text-xs hover:underline opacity-80 hover:opacity-100">Ê∏ÖÁ©∫</button>
                    </div>
                `;
                section.appendChild(header);

                // Body
                const body = document.createElement('div');
                body.className = 'p-3 grid grid-cols-2 gap-2';

                models.forEach(m => {
                    const isChecked = userModels.includes(m.id);
                    // Ê≥®ÊÑèÔºöÂ¶ÇÊûúÁî®Êà∑ÂàóË°®ÈáåÊ≤°Êúâ‰ªª‰ΩïËØ•Ê∏†ÈÅìÁöÑÊ®°ÂûãÔºåÈÄöÂ∏∏ÊÑèÂë≥ÁùÄÂÖ®ÈÉ®ÂÖÅËÆ∏„ÄÇ
                    // ‰ΩÜ‰∏∫‰∫Ü UI ÁöÑÊòéÁ°ÆÊÄßÔºåÊàë‰ª¨ËøôÈáåÂè™ÂèçÊò† allowed_models ÈáåÁöÑÁúüÂÆûÊï∞ÊçÆ„ÄÇ
                    // Âπ∂Âú®‰∏ãÊñπËØ¥Êòé "Êú™ÂãæÈÄâ‰ªª‰ΩïÊ®°Âûã = ÂÖ®ÈÉ®ÂèØÁî®"

                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-2 text-sm text-gray-700 hover:bg-gray-50 p-1.5 rounded cursor-pointer transition';
                    label.innerHTML = `
                        <input type="checkbox" value="${m.id}" ${isChecked ? 'checked' : ''} class="rounded border-gray-300 text-indigo-500 focus:ring-indigo-500 model-checkbox model-checkbox-${channel}">
                        <span class="truncate" title="${m.name}">${m.name}</span>
                    `;
                    body.appendChild(label);
                });
                section.appendChild(body);

                container.appendChild(section);
            });
        }

        function batchSelectModels(channel, selectAll) {
            document.querySelectorAll(`.model-checkbox-${channel}`).forEach(cb => {
                cb.checked = selectAll;
            });
        }

        async function saveUserPermissions() {
            if (!currentPermissionUserId) return;

            const selectedChannels = Array.from(document.querySelectorAll('.channel-checkbox:checked')).map(cb => cb.value);

            if (selectedChannels.length === 0) {
                showToast('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ê∏†ÈÅì', 'warning');
                return;
            }

            const modelCheckboxes = document.querySelectorAll('.model-checkbox:checked');
            const models = Array.from(modelCheckboxes).map(cb => cb.value);

            try {
                await fetchApi(`/api/admin/users/${currentPermissionUserId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        allowed_channels: selectedChannels,
                        allowed_models: models
                    })
                });

                hideModal('permissionModal');
                await loadUsers();
                showToast('ÊùÉÈôêÂ∑≤Êõ¥Êñ∞', 'success');
            } catch (e) {
                showToast('‰øùÂ≠òÊùÉÈôêÂ§±Ë¥•: ' + e.message, 'error');
            }
        }

        function showSubscriptionModal(userId, username) {
            currentSubscriptionUserId = userId;
            document.getElementById('sub-username').textContent = username;

            // ÈáçÁΩÆË°®Âçï
            document.getElementById('sub-type').value = '';
            document.getElementById('sub-quota').value = '';
            document.getElementById('sub-duration').value = '';
            document.querySelectorAll('input[name="sub-type-radio"]').forEach((r) => {
                r.checked = false;
            });
            document.getElementById('subscription-preview').classList.add('hidden');

            // Load current subscription info
            fetchApi(`/api/admin/users/${userId}/subscription`)
                .then(data => {
                    const sub = data.data;
                    if (sub.subscription_type && sub.subscription_type !== 'none') {
                        document.getElementById('sub-type').value = sub.subscription_type;
                        document.getElementById('sub-quota').value = sub.subscription_quota || '';

                        // ÈÄâ‰∏≠ÂØπÂ∫îÁöÑ radio
                        const radio = document.querySelector(`input[name="sub-type-radio"][value="${sub.subscription_type}"]`);
                        if (radio) radio.checked = true;

                        updatePreview();
                    }
                })
                .catch(e => {
                    console.error('Load subscription error:', e);
                });

            showModal('subscriptionModal');
        }

        function updateSubscriptionType(type) {
            document.getElementById('sub-type').value = type;
            updatePreview();
        }

        function applyTemplate(type, quota, duration) {
            // ËÆæÁΩÆÁ±ªÂûã
            document.getElementById('sub-type').value = type;
            const radio = document.querySelector(`input[name="sub-type-radio"][value="${type}"]`);
            if (radio) radio.checked = true;

            // ËÆæÁΩÆÈ¢ùÂ∫¶ÂíåÊó∂Èïø
            document.getElementById('sub-quota').value = quota;
            document.getElementById('sub-duration').value = duration;

            // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊåâÈíÆ
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-50', 'text-purple-600');
            });

            updatePreview();
            showToast('Â∑≤Â∫îÁî®Â•óÈ§êÊ®°Êùø', 'success');
        }

        function setDuration(months) {
            document.getElementById('sub-duration').value = months;

            // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊåâÈíÆ
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-50');
            });
            event.target.closest('.duration-btn').classList.add('border-purple-500', 'bg-purple-50');

            updatePreview();
        }

        function updatePreview() {
            const type = document.getElementById('sub-type').value;
            const quota = parseFloat(document.getElementById('sub-quota').value);
            const months = parseInt(document.getElementById('sub-duration').value);

            const preview = document.getElementById('subscription-preview');

            if (!type || !quota || !months) {
                preview.classList.add('hidden');
                return;
            }

            preview.classList.remove('hidden');

            // Êõ¥Êñ∞È¢ÑËßà‰ø°ÊÅØ
            const typeName = type === 'daily' ? 'ÊØèÊó•ÈáçÁΩÆ' : 'ÊØèÊúàÈáçÁΩÆ';
            document.getElementById('preview-type').textContent = typeName;
            document.getElementById('preview-quota').textContent = '$' + quota.toFixed(2);
            document.getElementById('preview-duration').textContent = months + ' ‰∏™Êúà';

            // ËÆ°ÁÆóÂà∞ÊúüÊó•ÊúüÔºà‰ΩøÁî®Ëá™ÁÑ∂ÊúàÔºâ
            const now = new Date();
            const expiresDate = new Date(now);
            expiresDate.setMonth(expiresDate.getMonth() + months);

            // Ê†ºÂºèÂåñÊó•ÊúüÔºåÊòæÁ§∫ÊòüÊúüÂá†
            const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
            const expiresStr = expiresDate.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' ' + weekdays[expiresDate.getDay()];

            document.getElementById('preview-expires').textContent = expiresStr;

            // ËÆ°ÁÆóÈ¢ÑËÆ°ÊÄªÂÖÖÂÄº
            let totalResets = 0;
            let resetFrequency = '';

            if (type === 'daily') {
                // ÊØèÊó•ÈáçÁΩÆÔºöËÆ°ÁÆóËøôÂá†‰∏™ÊúàÊÄªÂÖ±ÊúâÂ§öÂ∞ëÂ§©
                let totalDays = 0;
                const tempDate = new Date(now);
                for (let i = 0; i < months; i++) {
                    const daysInMonth = new Date(tempDate.getFullYear(), tempDate.getMonth() + 1, 0).getDate();
                    totalDays += daysInMonth;
                    tempDate.setMonth(tempDate.getMonth() + 1);
                }
                totalResets = totalDays;
                resetFrequency = 'ÊØèÂ§©ÂÖÖÂÄº‰∏ÄÊ¨°';
            } else if (type === 'monthly') {
                // ÊØèÊúàÈáçÁΩÆÔºöÂ∞±ÊòØÊúàÊï∞
                totalResets = months;
                resetFrequency = 'ÊØèÊúàÂÖÖÂÄº‰∏ÄÊ¨°';
            }

            const totalAmount = quota * totalResets;
            document.getElementById('preview-total').textContent =
                '$' + totalAmount.toFixed(2) + ' (' + totalResets + ' Ê¨° ¬∑ ' + resetFrequency + ')';
        }

        async function setSubscription() {
            const type = document.getElementById('sub-type').value;
            const quota = parseFloat(document.getElementById('sub-quota').value);
            const months = parseInt(document.getElementById('sub-duration').value);

            if (!type) {
                showToast('ËØ∑ÈÄâÊã©ËÆ¢ÈòÖÁ±ªÂûã', 'warning');
                return;
            }

            if (!quota || quota <= 0) {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂÖÖÂÄºÈ¢ùÂ∫¶', 'warning');
                return;
            }

            if (!months || months <= 0) {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËÆ¢ÈòÖÊó∂Èïø', 'warning');
                return;
            }

            try {
                await fetchApi(`/api/admin/users/${currentSubscriptionUserId}/subscription`, {
                    method: 'POST',
                    body: JSON.stringify({ type, quota, duration: months })
                });
                hideModal('subscriptionModal');
                loadUsers();
                showToast('ËÆ¢ÈòÖËÆæÁΩÆÊàêÂäü', 'success');
            } catch (e) {
                showToast('ËÆæÁΩÆÂ§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function cancelSubscription() {
            if (!confirm('Á°ÆÂÆöÂèñÊ∂àÊ≠§Áî®Êà∑ÁöÑËÆ¢ÈòÖÔºü\n\nÂèñÊ∂àÂêéÂ∞ÜÂÅúÊ≠¢Ëá™Âä®ÂÖÖÂÄºÔºå‰ΩÜ‰∏ç‰ºöÊâ£Èô§Â∑≤ÂÖÖÂÄºÁöÑ‰ΩôÈ¢ù„ÄÇ')) return;

            try {
                await fetchApi(`/api/admin/users/${currentSubscriptionUserId}/subscription`, {
                    method: 'DELETE'
                });
                hideModal('subscriptionModal');
                loadUsers();
                showToast('ËÆ¢ÈòÖÂ∑≤ÂèñÊ∂à', 'success');
            } catch (e) {
                showToast('ÂèñÊ∂àÂ§±Ë¥•: ' + e.message, 'error');
            }
        }

        async function refresh() { loadStatus(); loadUsers(); loadAccounts(); loadAgtAccounts(); }

        (async () => {
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            document.getElementById('loadingPage').classList.add('hidden');
            document.getElementById('mainPanel').classList.remove('hidden');
            updateUsernamePreview(); // ÂàùÂßãÂåñÁî®Êà∑ÂêçÈ¢ÑËßà
            refresh();
        })();

        // Ëá™Âä®Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆÔºàÊØè30ÁßíÔºâ
        setInterval(() => {
            if (token && !document.getElementById('mainPanel').classList.contains('hidden')) {
                loadStatus();
            }
        }, 30000);
    </script>
    <!-- Global Machine ID Tooltip -->
    <div id="global-machine-tooltip"
        class="fixed z-[100] hidden opacity-0 invisible transition-all duration-200 bg-white rounded-xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] border border-gray-100 p-4 text-left w-72 backdrop-blur-sm ring-1 ring-black/5"
        onmouseenter="keepTooltipOpen()" onmouseleave="hideMachineIdTooltip()">
    </div>
</body>

</html>