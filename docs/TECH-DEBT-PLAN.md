# 技术债治理计划（下轮执行）

目标：不做大重构，在保证线上稳定的前提下，逐步降低维护成本与回归风险。

## 一、范围与原则

- 只做低风险、可回滚改动
- 每次改动都可独立验证
- 先修“会影响后续开发效率/稳定性”的债，再修“美化类”债

## 二、债务清单（按优先级）

### P0（优先处理）

1. `src/public/admin.html` 现存静态检查问题
   - 现象：Biome 报错（重复声明、forEach 回调返回值、表达式赋值等）
   - 风险：后续改动容易引入连锁问题
   - 目标：清零当前可见 Biome 错误（仅修语法/结构，不改业务行为）

2. 管理页单文件过大（`src/public/admin.html`）
   - 现象：账号/用户/日志/订阅逻辑耦合在一个文件
   - 风险：小改动影响面过大，回归成本高
   - 目标：先按“功能块”拆分为 2~3 个 JS 模块（不改 UI）

### P1（短期处理）

3. 状态数据双口径
   - 现象：`/metrics` 偏内存态，`/api/admin/stats/overview` 偏 DB 聚合
   - 风险：短时不一致导致排障误判
   - 目标：补充一致性说明与排障步骤；后续评估是否统一为单口径

4. 路由层存在直接 SQL
   - 现象：`admin-new.js` 中有 `db.db.prepare(...)`
   - 风险：数据访问风格不统一，复用差
   - 目标：逐步下沉到 `DatabaseManager`，路由只调方法

5. 状态变更规则分散
   - 现象：pool/failover/admin route 多处写状态
   - 风险：未来加状态或改规则时容易漏改
   - 目标：收敛到少数入口函数（先文档化，再代码收敛）

### P2（后续处理）

6. 缺少自动化测试
   - 目标：补关键回归测试（删除普通/force、禁用/启用、状态统计）

7. 强制删除缺少审计追踪
   - 目标：记录谁在何时执行 `force=true`，删除了多少日志

## 三、分阶段执行计划

### 第 1 阶段（半天）

- 修复 `admin.html` 现有 Biome 报错
- 验证：LSP/静态检查无新增错误

### 第 2 阶段（1 天）

- 前端轻拆分：
  - `admin-accounts.js`（账号表与操作）
  - `admin-users.js`（用户与订阅）
  - `admin-shared.js`（fetch/toast/工具函数）
- 验证：页面功能与现状一致，不新增交互变化

### 第 3 阶段（半天）

- 清理路由层直接 SQL（先从账号管理相关接口开始）
- 验证：接口返回结构不变

### 第 4 阶段（1 天）

- 补最小回归测试（关键 API）
- 验证：至少覆盖删除/禁用/启用/统计链路

## 四、验收标准

- `admin.html` 的现有 Biome 报错清零（或降到可接受且有说明）
- 管理端核心接口返回结构保持兼容
- 删除与状态更新链路无回归
- 文档更新与代码行为一致

## 五、回滚策略

- 每个阶段独立提交（可单独回滚）
- 不做跨阶段耦合改动
- 若出现线上风险，优先回滚最近阶段，不连带回滚已稳定阶段
